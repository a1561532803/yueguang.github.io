<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="爬虫——基础篇, HTML,CSS,JavaScript,JQuery,Vue.js,photoshop,Unity,UE等">
    <meta name="description" content="分享知识,分享经验,偶尔写点段子">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>爬虫——基础篇 | 在月光下滑坡</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="在月光下滑坡" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/girl.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">在月光下滑坡</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="https://a1561532803.github.io/yueguang.github.io/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/bb" class="waves-effect waves-light">

      
      <i class="fas fa-comment" style="zoom: 0.6;"></i>
      
      <span>说说</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>留言区</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/demo" class="waves-effect waves-light">
      
      <i class="fas fa-tv" style="zoom: 0.6;"></i>
      
      <span>demo</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/girl.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">在月光下滑坡</div>
        <div class="logo-desc">
            
            分享知识,分享经验,偶尔写点段子
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="https://a1561532803.github.io/yueguang.github.io/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-comment"></i>
			
			说说
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/contact " style="margin-left:50px">
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:28px" ></i>
			      
		          <span>留言区</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/demo" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tv"></i>
			
			demo
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">爬虫——基础篇</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E7%88%AC%E8%99%AB/">
                                <span class="chip bg-color">爬虫</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/python/" class="post-category">
                                python
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-10
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-07-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    21.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    97 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>转载自：ZY.Zhang</p>
<p>本文档基于<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Yh411o7Sz?p=1">B站视频教程</a></p>
</blockquote>
<h1 id="一、爬虫基础简介"><a href="#一、爬虫基础简介" class="headerlink" title="一、爬虫基础简介"></a>一、爬虫基础简介</h1><h2 id="1-爬虫简介"><a href="#1-爬虫简介" class="headerlink" title="1. 爬虫简介"></a>1. 爬虫简介</h2><p><strong>什么是爬虫：</strong>通过编写程序，模拟浏览器上网，然后让其去互联网上抓取数据的过程。</p>
<h2 id="2-爬虫合法性探究"><a href="#2-爬虫合法性探究" class="headerlink" title="2. 爬虫合法性探究"></a>2. 爬虫合法性探究</h2><p><strong>爬虫究竟是合法还是违法的？</strong></p>
<ul>
<li>在法律中是不被禁止的</li>
<li>具有违法风险</li>
<li>善意爬虫 &amp; 恶意爬虫</li>
</ul>
<p><strong>爬虫带来的风险可以体现在如下两个方面：</strong></p>
<ol>
<li>爬虫干扰了被访问网站的正常运营</li>
<li>爬虫抓取了受到法律保护的特定类型的数据或信息</li>
</ol>
<p><strong>如何在编写使用的过程中避免进入局子的厄运？</strong></p>
<ul>
<li>时常优化自己的程序，避免干扰被访问网站的正常运行</li>
<li>在使用，传播爬取到的数据时，审查抓取到的内容，如果发现了涉及到用户隐私或者商业机密等敏感内容，需要及时停止爬取或者传播。</li>
</ul>
<h2 id="3-爬虫初试深入"><a href="#3-爬虫初试深入" class="headerlink" title="3. 爬虫初试深入"></a>3. 爬虫初试深入</h2><p><strong>爬虫在使用场景中的分类：</strong></p>
<ul>
<li><p><strong>通用爬虫：</strong>抓取系统的重要组成部分。抓取的是一整张页面数据。</p>
</li>
<li><p><strong>聚焦爬虫：</strong>是建立在通用爬虫的基础之上。抓取的是页面中特定的局部内容。</p>
</li>
<li><p><strong>增量式爬虫：</strong>监测网站中数据更新的情况。只会抓取网站中最新更新出来的数据。</p>
</li>
</ul>
<p><strong>爬虫的矛与盾：</strong></p>
<ul>
<li><p><strong>反爬机制：</strong>门户网站，可以通过制定相应的策略或者技术手段，防止爬虫程序进行网站数据的爬取。</p>
</li>
<li><p><strong>反反爬策略：</strong>爬虫程序，可以通过制定相关的策略或者技术手段，破解门户网站中具备的反爬机制，从而可以获取门户网站中相关的数据。</p>
</li>
</ul>
<p><strong>robots.txt协议：</strong>君子协议。规定了网站中那些数据可以被爬虫爬取，那些数据不允许被爬取。</p>
<p>例如：<a target="_blank" rel="noopener" href="https://www.tabao.com/robots.txt">www.tabao.com/robots.txt</a></p>
<h2 id="4-http-amp-https协议"><a href="#4-http-amp-https协议" class="headerlink" title="4. http&amp;https协议"></a>4. http&amp;https协议</h2><h3 id="（1）http协议"><a href="#（1）http协议" class="headerlink" title="（1）http协议"></a>（1）http协议</h3><p><strong>概念：</strong>就是服务器和客户端进行数据交互的一种形式。</p>
<p><strong>常用请求头信息：</strong></p>
<ul>
<li><strong>User-Agent：</strong>请求载体的身份标识</li>
<li><strong>Connection：</strong>请求完毕后，是断开连接还是保持连接</li>
</ul>
<p><strong>常用响应头信息：</strong></p>
<ul>
<li><strong>Content-Type：</strong>服务器响应回客户端的数据类型</li>
</ul>
<h3 id="（2）https协议"><a href="#（2）https协议" class="headerlink" title="（2）https协议"></a>（2）https协议</h3><p><strong>概念：</strong>安全的超文本传输协议</p>
<h3 id="（3）加密方式"><a href="#（3）加密方式" class="headerlink" title="（3）加密方式"></a>（3）加密方式</h3><ul>
<li><p><strong>对称秘钥加密</strong></p>
<p>  <img src="../PythonProjects/Typora_image/image-20210224142616421.png" alt="image-20210224142616421"></p>
</li>
<li><p><strong>非对称秘钥加密</strong></p>
<p>  存在缺点：第一个是如何保证接收端向发送端发出公开秘钥的时候，发送端确保收到的是预先要发送的，而不会被挟持，只要是发送秘钥，就有可能有被挟持的风险；第二个是非对称秘钥加密方式效率比较低，处理起来更为复杂，通信过程中使用就有一定的效率问题而影响通信速度。</p>
<p>  <img src="../PythonProjects/Typora_image/image-20210224142728145.png" alt="image-20210224142728145"></p>
</li>
<li><p><strong>证书秘钥加密：</strong></p>
<ul>
<li>服务器的开发者携带公开密钥，向数字证书认证机构提出公开密钥的申请，数字证书认证机构在认清申请者的身份审核通过以后，会对开发者申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将密钥放在证书里面，绑定在一起；</li>
<li>服务器将这份数字证书发送给客户端，因为客户端也认可证书机构，客户端可以通过数字证书中的数字签名来验证公钥的真伪，来确保服务器传过来的公开密钥是真实的。一般情况下，证书的数字签名是很难被伪造的，这取决于认证机构的公信力。一旦确认信息无误之后，客户端就会通过公钥对报文进行加密发送，服务器接收到以后用自己的私钥进行解密。</li>
</ul>
<p>  <img src="../PythonProjects/Typora_image/image-20210224143442798.png" alt="image-20210224143442798"></p>
</li>
</ul>
<hr>
<h1 id="二、requests模块基础"><a href="#二、requests模块基础" class="headerlink" title="二、requests模块基础"></a>二、requests模块基础</h1><h2 id="1-requests第一血"><a href="#1-requests第一血" class="headerlink" title="1. requests第一血"></a>1. requests第一血</h2><p><strong>requests模块：</strong>Python中原生的一款基于网络请求的模块，功能非常强大，简单便捷，效率极高。</p>
<p><strong>作用：</strong>模拟浏览器发请求。</p>
<p><strong>如何使用：（requests模块的编码流程）</strong></p>
<ul>
<li>指定 url</li>
<li>发起请求</li>
<li>获取响应数据</li>
<li>持久化存储</li>
</ul>
<p><strong>环境的安装：</strong><code>pip install requests</code></p>
<p><strong>实战编码：</strong></p>
<ul>
<li>需求：爬取搜狗首页的数据</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#step1 指定url</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.sogou.com/'</span>
    <span class="token comment">#step2 发起请求</span>
    <span class="token comment">#get方法会返回一个响应对象</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">)</span>
    <span class="token comment">#step3 获取响应数据，text返回的是字符串形式的响应数据</span>
    page_text <span class="token operator">=</span> response<span class="token punctuation">.</span>text
    <span class="token keyword">print</span><span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    <span class="token comment">#step4 持久化存储</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./sogou.html'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'爬取数据结束！'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-requests巩固深入案例介绍"><a href="#2-requests巩固深入案例介绍" class="headerlink" title="2. requests巩固深入案例介绍"></a>2. requests巩固深入案例介绍</h2><h3 id="（1）简易网页采集器"><a href="#（1）简易网页采集器" class="headerlink" title="（1）简易网页采集器"></a>（1）简易网页采集器</h3><ul>
<li>UA检测</li>
<li>UA伪装</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#UA：User-Agent请求载体的身份标识</span>
<span class="token triple-quoted-string string">'''UA检测：门户网站的服务器会监测对应请求的载体身份标识，
如果检测到请求载体身份标识是某一款浏览器,说明该请求时一个正常的请求；
但是，如果检测到请求的载体身份不是基于某一款浏览器的，则表示该请求为不正常请求（爬虫）,
则服务器很有可能拒绝该次请求'''</span>

<span class="token comment">#UA伪装：让爬虫对应的请求载体身份标识伪装成某一款浏览器，躲过UA检测</span>
<span class="token keyword">import</span> requests
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#UA伪装：将对应的User-Agent封装到一个字典中</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">#step1 指定url query</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.sogou.com/web'</span>
    <span class="token comment">#处理url携带的参数 封装到字典中</span>
    kw <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Enter a word:'</span><span class="token punctuation">)</span>
    param <span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'query'</span><span class="token punctuation">:</span>kw
    <span class="token punctuation">}</span>
    <span class="token comment">#step2 对指定的url发起请求，对应的url是携带参数的，并且处理过程中处理了参数</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span>params <span class="token operator">=</span> param<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
    <span class="token comment">#step3</span>
    page_text <span class="token operator">=</span> response<span class="token punctuation">.</span>text
    <span class="token comment">#step4</span>
    fileName <span class="token operator">=</span> kw <span class="token operator">+</span> <span class="token string">'.html'</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding <span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span><span class="token string">'保存成功！！'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）破解百度翻译"><a href="#（2）破解百度翻译" class="headerlink" title="（2）破解百度翻译"></a>（2）破解百度翻译</h3><ul>
<li>post请求（携带了参数）</li>
<li>响应数据是一组json数据</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#step1 指定URL</span>
    post_url <span class="token operator">=</span> <span class="token string">'https://fanyi.baidu.com/sug'</span>
    
    <span class="token comment">#step2 进行UA伪装</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">#step3 post请求参数处理（同get请求类似）</span>
    word <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Enter a word:\n'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'kw'</span><span class="token punctuation">:</span>word
    <span class="token punctuation">}</span>
    
    <span class="token comment">#step4 请求发送</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">=</span> post_url<span class="token punctuation">,</span>data <span class="token operator">=</span> data<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
    
    <span class="token comment">#step5 获取响应数据:json()方法返回的是obj  (如果确认响应数据是json类型--&gt;通过Content-Type分辨，才可以直接用json方法)</span>
    dict_obj <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dict_obj<span class="token punctuation">)</span>
    
    <span class="token comment">#step6 持久化存储</span>
    fileName <span class="token operator">=</span> word <span class="token operator">+</span> <span class="token string">'.json'</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>dict_obj<span class="token punctuation">,</span>fp <span class="token operator">=</span> fp<span class="token punctuation">,</span>ensure_ascii <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Over!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）豆瓣电影"><a href="#（3）豆瓣电影" class="headerlink" title="（3）豆瓣电影"></a>（3）豆瓣电影</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/j/chart/top_list'</span>
    param <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'type'</span><span class="token punctuation">:</span><span class="token string">'24'</span><span class="token punctuation">,</span>
        <span class="token string">'interval_id'</span><span class="token punctuation">:</span><span class="token string">'100:90'</span><span class="token punctuation">,</span>
        <span class="token string">'action'</span><span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'start'</span><span class="token punctuation">:</span><span class="token string">'0'</span><span class="token punctuation">,</span>	<span class="token comment">#从库中的第几部电影去取</span>
        <span class="token string">'limit'</span><span class="token punctuation">:</span><span class="token string">'20'</span>	<span class="token comment">#一次取出的个数</span>
    <span class="token punctuation">}</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span>params <span class="token operator">=</span> param<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
    list_data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./douban.json'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>list_data<span class="token punctuation">,</span>fp <span class="token operator">=</span> fp<span class="token punctuation">,</span>ensure_ascii <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Over!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-作业—肯德基餐厅查询"><a href="#3-作业—肯德基餐厅查询" class="headerlink" title="3. 作业—肯德基餐厅查询"></a>3. 作业—肯德基餐厅查询</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    post_url <span class="token operator">=</span> <span class="token string">'https://www.kfc.com.cn/kfccda/ashx/GetStoreList.ashx?op=keyword'</span>
    keyword <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'请输入要查询的城市：'</span><span class="token punctuation">)</span>

    data <span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'cname'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'pid'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'keyword'</span><span class="token punctuation">:</span> keyword<span class="token punctuation">,</span>
        <span class="token string">'pageindex'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token string">'pageSize'</span><span class="token punctuation">:</span> <span class="token string">'10'</span>
    <span class="token punctuation">}</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">=</span> post_url<span class="token punctuation">,</span> data <span class="token operator">=</span> data<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>

    <span class="token comment"># 持久化存储</span>
    <span class="token comment"># page_text = response.text</span>
    <span class="token comment"># fileName = keyword + '.html'</span>
    <span class="token comment"># with open(fileName, 'w', encoding= 'utf-8') as fp:</span>
    <span class="token comment">#     fp.write(page_text)</span>
    <span class="token comment"># print(fileName, 'Over!')</span>

    <span class="token comment"># 直接打印出来</span>
    page <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token builtin">dict</span> <span class="token keyword">in</span> page<span class="token punctuation">[</span><span class="token string">'Table1'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        StoreName <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token string">'storeName'</span><span class="token punctuation">]</span>
        address <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token string">'addressDetail'</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'StoreName:'</span> <span class="token operator">+</span> StoreName<span class="token punctuation">,</span> <span class="token string">'address:'</span> <span class="token operator">+</span> address <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-综合练习—药监总局"><a href="#4-综合练习—药监总局" class="headerlink" title="4. 综合练习—药监总局"></a>4. 综合练习—药监总局</h2><ul>
<li><p>爬取国家药品监督管理总局中<strong>基于中华人民共和国化妆品生产许可证相关数据</strong>（<a target="_blank" rel="noopener" href="http://scxk.nmpa.gov.cn:81/xk/%EF%BC%89">http://scxk.nmpa.gov.cn:81/xk/）</a></p>
</li>
<li><p><strong>动态加载数据：</strong>首页中对应的企业信息是通过 <code>ajax</code> 动态请求到的</p>
</li>
<li><p>通过对详情页url的观察发现：</p>
<ul>
<li>url的域名都是一样的，只有携带的参数（id）不一样</li>
<li>id值可以从首页对应的 <code>ajax</code> 请求到的 <code>json</code> 串中获取</li>
<li>域名和id值拼接出一个完整的企业对应的详情页的url</li>
</ul>
</li>
<li><p><strong>详情页的企业详情数据也是动态加载出来的！！！</strong></p>
<ul>
<li>观察后发现，所有 <code>post</code> 请求的url都是一样的，只有参数id值不同</li>
<li>如果我们可以批量获取多家企业的id后，就可以就id和url形成一个完整的详情页对应详情数据的 <code>ajax</code> 请求的url</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储企业的id</span>
    all_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储企业所有的详情数据</span>
    <span class="token comment"># 批量获取不同企业的id值</span>
    url <span class="token operator">=</span> <span class="token string">'http://scxk.nmpa.gov.cn:81/xk/itownet/portalAction.do?method=getXkzsList'</span>
    <span class="token comment"># 参数的封装</span>
    <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        page <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'on'</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token punctuation">,</span>
            <span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
            <span class="token string">'pageSize'</span><span class="token punctuation">:</span> <span class="token string">'15'</span><span class="token punctuation">,</span>
            <span class="token string">'productName'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string">'conditionType'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
            <span class="token string">'applyname'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string">'applysn'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    json_ids <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 从 json_ids 字典中拿到 list 对应的 value 值，对 value 值列表进行遍历</span>
    <span class="token keyword">for</span> dic <span class="token keyword">in</span> json_ids<span class="token punctuation">[</span><span class="token string">'list'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        id_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dic<span class="token punctuation">[</span><span class="token string">'ID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># print(id_list,'\n')</span>

    <span class="token comment"># 获取企业详情数据,也是动态加载出来的，携带一个参数 id，其值可以通过前一步生成的 id列表提取</span>
    post_url <span class="token operator">=</span> <span class="token string">'http://scxk.nmpa.gov.cn:81/xk/itownet/portalAction.do?method=getXkzsById'</span>
    <span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> id_list<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token builtin">id</span>
        <span class="token punctuation">}</span>

        json_detail <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>post_url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#print(json_detail, '-------------END----------')</span>
        all_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>json_detail <span class="token punctuation">)</span>
        all_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'---------------------------------------------------------'</span><span class="token punctuation">)</span>


    <span class="token comment"># 持久化存储all_data_list</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./allData.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>all_data_list<span class="token punctuation">,</span> fp<span class="token operator">=</span>fp<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># indent 自动排版</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Over!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="三、数据解析"><a href="#三、数据解析" class="headerlink" title="三、数据解析"></a>三、数据解析</h1><h2 id="1-数据解析概述"><a href="#1-数据解析概述" class="headerlink" title="1. 数据解析概述"></a>1. 数据解析概述</h2><ul>
<li><strong>聚焦爬虫：</strong>爬取页面中指定的页面内容。<ul>
<li>编码流程：1. 指定URL → 2. 发起请求 → 3. 获取响应数据 → 4. 数据解析 → 5. 持久化存储</li>
</ul>
</li>
<li><strong>数据解析分类：</strong><ul>
<li>正则表达式</li>
<li><code>bs4</code> 解析</li>
<li><code>xpath</code> 解析（重点）</li>
</ul>
</li>
<li><strong>数据解析原理概述：</strong>解析的局部的文本内容都会在标签对应的属性中进行存储。<ul>
<li>进行指定标签的定位</li>
<li>标签或者标签对应的属性中存储的数据值进行提取（解析）</li>
</ul>
</li>
</ul>
<h2 id="2-图片数据爬取—正则表达式"><a href="#2-图片数据爬取—正则表达式" class="headerlink" title="2. 图片数据爬取—正则表达式"></a>2. 图片数据爬取—正则表达式</h2><table>
<thead>
<tr>
<th align="center"><strong>操作符</strong></th>
<th align="center"><strong>说明</strong></th>
<th align="center"><strong>实例</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>.</strong></td>
<td align="center">表示任意单个字符</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>[ ]</strong></td>
<td align="center">字符集，对单个字符给出取值范围</td>
<td align="center">[abc]表示a,b,c,[a-z]表示a-z的</td>
</tr>
<tr>
<td align="center"><strong>[^ ]</strong></td>
<td align="center">非字符集，对单个字符给出排除范围</td>
<td align="center">[^abc]表示非a或b或c的单个字符</td>
</tr>
<tr>
<td align="center">*****</td>
<td align="center">前一个字符0次或无限次扩展</td>
<td align="center">abc* 表示ab、abc、abcc、abccc等</td>
</tr>
<tr>
<td align="center"><strong>+</strong></td>
<td align="center">前一个字符1次或无限次扩展</td>
<td align="center">abc+ 表示abc、abcc、abccc等</td>
</tr>
<tr>
<td align="center"><strong>?</strong></td>
<td align="center">前一个字符0次或1次扩展</td>
<td align="center">abc？ 表示ab、abc</td>
</tr>
<tr>
<td align="center"><strong>|</strong></td>
<td align="center">左右表达式任意一个</td>
<td align="center">abc|def 表示abc、def</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center"><strong>{m}</strong></th>
<th align="center">扩展前一个字符m次</th>
<th align="center">ab{2}c表示abbc</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>{m,n}</strong></td>
<td align="center">扩展前一个字符m至n次（含n）</td>
<td align="center">ab{1，2}c表示abc、abbc</td>
</tr>
<tr>
<td align="center"><strong>^</strong></td>
<td align="center">匹配字符串开头</td>
<td align="center">^abc表示abc且在一个字符串的开头</td>
</tr>
<tr>
<td align="center"><strong>$</strong></td>
<td align="center">匹配字符串结尾</td>
<td align="center">abc$表示abc且在一个字符串的结尾</td>
</tr>
<tr>
<td align="center"><strong>( )</strong></td>
<td align="center">分组标记，内部只能使用|操作符</td>
<td align="center">(abc)表示abc，(abc|def)表示abc、def</td>
</tr>
<tr>
<td align="center"><strong>\d</strong></td>
<td align="center">数字，等价于[0-9]</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>\w</strong></td>
<td align="center">单词字符，等价于[A-Za-z0-9_]</td>
<td align="center"></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>re.search()</strong></td>
<td align="center">在一个字符串中搜索匹配正则表达式的第一个位置，<strong>返回match对象</strong></td>
</tr>
<tr>
<td align="center"><strong>re.match()</strong></td>
<td align="center">从字符串的开始位置起匹配正则表达式，<strong>返回match对象</strong></td>
</tr>
<tr>
<td align="center"><strong>re.findall()</strong></td>
<td align="center">搜搜字符串，以列表类型返回全部能匹配的子串</td>
</tr>
<tr>
<td align="center"><strong>re.split()</strong></td>
<td align="center">将一个字符串按照正则表达式匹配结果进行分割，<strong>返回列表类型</strong></td>
</tr>
<tr>
<td align="center"><strong>re.finditer()</strong></td>
<td align="center">搜索字符串，返回一个匹配结果的迭代类型，<strong>每个迭代元素是match对象</strong></td>
</tr>
<tr>
<td align="center"><strong>re.sub()</strong></td>
<td align="center">在一个字符串中替换所有匹配正则表达式的子串，返回替换后的字符串</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">修饰符</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">re.I</td>
<td align="center">使匹配对大小写不敏感</td>
</tr>
<tr>
<td align="center">re.L</td>
<td align="center">做本地化识别匹配</td>
</tr>
<tr>
<td align="center">re.M</td>
<td align="center">多行匹配，影响^和$</td>
</tr>
<tr>
<td align="center">re.S</td>
<td align="center">使.匹配包括换行在内的所有字符</td>
</tr>
<tr>
<td align="center">re.U</td>
<td align="center">根据Unicode字符集解析字符，这个标志影响\w,\W,\b,\B</td>
</tr>
<tr>
<td align="center">re.X</td>
<td align="center">该标志通过给予你跟灵活的格式以便你将正则表达式写得更易于理解</td>
</tr>
</tbody></table>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">常用的正则表达式

单字符：
			.	:	除换行以外所有字符

<span class="token code keyword">			[ ]	: 	[aoe]  [a-w] 匹配集合中任意一个字符</span>

<span class="token code keyword">			\d	:	数字 [0-9]</span>

<span class="token code keyword">			\D	:	非数字</span>

<span class="token code keyword">			\w	:	数字、字母、下划线、中文</span>

<span class="token code keyword">			\W	:	非\w</span>

<span class="token code keyword">			\s	 :	所有的空白字符包，包括空格、制表符、换页符等等，等价于[ \f \n \r \t \v ]</span>

<span class="token code keyword">			\S	:	非空白</span>

数量修饰：
			 \*	:	任意多次	&gt;=0

<span class="token code keyword">			\+	:	至少一次	&gt;=1</span>

<span class="token code keyword">			?	:	可有可无	0次或者1次</span>

<span class="token code keyword">		{m}	:	固定m次	hello{3,}</span>

<span class="token code keyword">		{m,}	:	至少m次</span>

<span class="token code keyword">		{m,n}	:	m-n次</span>

边界：
			\$	:	以某某结尾

<span class="token code keyword">			^	:	以某某开头</span>

分组：
			(ab)

贪婪模式：	.\*

非贪婪（惰性）模式：	.\*?

re.I	:	忽略大小写

re.M	:	多行匹配

re.S	:	单行匹配

re.sub	:	正则表达式，替换内容，字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''正则练习'''</span>
<span class="token keyword">import</span> re
<span class="token comment">#提取出python</span>
key <span class="token operator">=</span> <span class="token string">"javapythonc++php"</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'python'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">#提取出hello world</span>
key <span class="token operator">=</span> <span class="token string">"&lt;html&gt;&lt;h1&gt;&lt;hello world&gt;&lt;h1&gt;&lt;/html&gt;"</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;h1&gt;(.*)&lt;h1&gt;'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">#提取170</span>
string <span class="token operator">=</span> '我喜欢身高为<span class="token number">170</span>的女孩’
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\d+'</span><span class="token punctuation">,</span> string<span class="token punctuation">)</span>

<span class="token comment">#提取出http://和https://</span>
key <span class="token operator">=</span> <span class="token string">'http://www.baidu.com and https://boob.com'</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'https?://'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

<span class="token comment">#提取出hello</span>
key <span class="token operator">=</span> <span class="token string">'lalala&lt;hTml&gt;&lt;hello&gt;&lt;/HtMl&gt;hahah'</span> 	<span class="token comment">#输出&lt;hTml&gt;&lt;hello&gt;&lt;/HtMl&gt;</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;[Hh][Tt][mM][lL]&gt;(.*)&lt;/[Hh][Tt][mM][lL]&gt;'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

<span class="token comment">#提取出hit.</span>
key <span class="token operator">=</span> <span class="token string">'bobo@hit.edu.com'</span>	<span class="token comment">#想要匹配到hit</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'h.*?\.'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

<span class="token comment">#匹配sas和saas</span>
key <span class="token operator">=</span> <span class="token string">'sasa and sas and saaas'</span>
re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'sa{1,2}s'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#如何爬取图片</span>
    url <span class="token operator">=</span> <span class="token string">'https://pic.qiushibaike.com/system/pictures/12409/124098453/medium/YNPHJQC101MS31E1.jpg'</span>
    <span class="token comment">#content返回的是二进制形式的图片数据</span>
    <span class="token comment">#text(字符串)  content(二进制)	json(队形)</span>
    img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span>content
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./qiutu.jpg'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-正则解析案例"><a href="#3-正则解析案例" class="headerlink" title="3. 正则解析案例"></a>3. 正则解析案例</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 需求：爬取糗事百科中糗图板块下所有的糗图图片</span>
<span class="token triple-quoted-string string">'''&lt;div class="thumb"&gt;
&lt;a href="/article/124098472" target="_blank"&gt;
&lt;img src="//pic.qiushibaike.com/system/pictures/12409/124098472/medium/HSN2WWN0TP1VUPNG.jpg" alt="糗事#124098472" class="illustration" width="100%" height="auto"&gt;
&lt;/a&gt;
&lt;/div&gt;'''</span>
<span class="token keyword">import</span> re
<span class="token keyword">import</span> os
<span class="token keyword">import</span> requests

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个文件夹，保存所有的图片</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./qiutuLibs'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'./qiutuLibs'</span><span class="token punctuation">)</span>

    url <span class="token operator">=</span> <span class="token string">'https://www.qiushibaike.com/imgrank/ '</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 使用通用爬虫对url对应的一整张页面进行爬取</span>
    page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token comment">#print(page_text)</span>

    <span class="token comment">#使用聚焦爬虫将页面中所有的糗图进行解析提取</span>
    ex <span class="token operator">=</span> <span class="token string">'&lt;div class="thumb"&gt;.*?&lt;img src="(.*?)" alt=.*?&lt;/div&gt;'</span>

    img_src_list <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>ex<span class="token punctuation">,</span> page_text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>img_src_list<span class="token punctuation">)</span>
    <span class="token keyword">for</span> src <span class="token keyword">in</span> img_src_list<span class="token punctuation">:</span>
        <span class="token comment">#拼接出完整的图片url</span>
        src <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> src
        img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> src<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        <span class="token comment">#生成图片名称</span>
        img_name <span class="token operator">=</span> src<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        imgPath <span class="token operator">=</span> <span class="token string">'./qiutuLibs/'</span> <span class="token operator">+</span> img_name
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
            fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img_name<span class="token punctuation">,</span> <span class="token string">'下载成功!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 对上述代码进行进一步处理，使得能够分页爬取图片</span>
<span class="token keyword">import</span> re
<span class="token keyword">import</span> os
<span class="token keyword">import</span> requests

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个文件夹，保存所有的图片</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./qiutuLibs'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'./qiutuLibs'</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置一个通用的url模板</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.qiushibaike.com/imgrank/page/%d/'</span>
    <span class="token keyword">for</span> pageNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 对应页码的 url</span>
        new_url <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>url <span class="token operator">%</span> pageNum<span class="token punctuation">)</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># 使用通用爬虫对url对应的一整张页面进行爬取</span>
        page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>new_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token comment">#print(page_text)</span>

        <span class="token comment">#使用聚焦爬虫将页面中所有的糗图进行解析提取</span>
        ex <span class="token operator">=</span> <span class="token string">'&lt;div class="thumb"&gt;.*?&lt;img src="(.*?)" alt=.*?&lt;/div&gt;'</span>

        img_src_list <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>ex<span class="token punctuation">,</span> page_text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img_src_list<span class="token punctuation">)</span>
        <span class="token keyword">for</span> src <span class="token keyword">in</span> img_src_list<span class="token punctuation">:</span>
            <span class="token comment">#拼接出完整的图片url</span>
            src <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> src
            img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> src<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
            <span class="token comment">#生成图片名称</span>
            img_name <span class="token operator">=</span> src<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            imgPath <span class="token operator">=</span> <span class="token string">'./qiutuLibs/'</span> <span class="token operator">+</span> img_name
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
                fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>img_name<span class="token punctuation">,</span> <span class="token string">'下载成功!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-bs4解析概述"><a href="#4-bs4解析概述" class="headerlink" title="4. bs4解析概述"></a>4. bs4解析概述</h2><ul>
<li><strong>数据解析的原理：</strong><ul>
<li><ol>
<li>标签定位</li>
<li>提取标签、标签属性中存储的数据值</li>
</ol>
</li>
</ul>
</li>
<li><strong>bs4数据解析的原理：</strong><ul>
<li><ol>
<li>实例化一个<code>BeautifulSoup</code>对象，并且将页面源码数据加载到该对象中</li>
<li>通过调用<code>BeautifulSoup</code>对象中相关的属性或者方法进行标签定位和数据提取</li>
</ol>
</li>
</ul>
</li>
<li><strong>环境安装：</strong><code>pip install bs4</code>         <code>pip  install  lxml</code></li>
</ul>
<h2 id="5-bs4-解析具体讲解"><a href="#5-bs4-解析具体讲解" class="headerlink" title="5. bs4 解析具体讲解"></a>5. bs4 解析具体讲解</h2><ul>
<li><strong>如何实例化 BeautifulSoup 对象：</strong></li>
<li>导包，<code>from bs4 import BeautifulSoup</code><ul>
<li>对象的实例化：<ul>
<li>（1）将本地的 html 文档中的数据加载到该对象中；</li>
<li>（2）将互联网上获取的页面源码加载到该对象中。</li>
</ul>
</li>
<li>提供的用于数据解析的方法和属性：<ul>
<li><code>soup.tagName</code>：返回的是文档中第一次出现的 <code>tagName</code> 标签；</li>
<li> <code>soup.find(tagName)</code>：可以等同于<code>soup.tagName</code>；也可以进行属性定位；</li>
<li><code>soup.find_all( )</code>：返回符合要求的所有标签；</li>
<li><code>select('某种选择器(id,class,标签...选择器)')</code>返回的是一个列表；层级选择器</li>
</ul>
</li>
<li>获取标签之间的文本数据：<code>soup.a.text/string/get_text( )</code><ul>
<li><code>text/get_text( )</code>：可以获取某一个标签中所有的文本内容</li>
<li><code>string</code>：只可以获取该标签下面直系的文本内容</li>
</ul>
</li>
<li><strong>获取标签中的属性值：</strong><code>soup.a['href']</code></li>
</ul>
</li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>测试bs4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>百里守约<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>song<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>李清照<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>王安石<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>苏轼<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>柳宗元<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.song.com/<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>赵匡胤<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_self<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>this is span<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
		宋朝是最强大的王朝，不是军队的强大，而是经济很强大，国民都很有钱<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>du<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>总为浮云能蔽日,长安不见使人愁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.baidu.com/meinv.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tang<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.baidu.com<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qing<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>清明时节雨纷纷,路上行人欲断魂,借问酒家何处有,牧童遥指杏花村<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.163.com<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>秦时明月汉时关,万里长征人未还,但使龙城飞将在,不教胡马度阴山<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.126.com<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qi<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>岐王宅里寻常见,崔九堂前几度闻,正是江南好风景,落花时节又逢君<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.sina.com<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>du<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>杜甫<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.dudu.com<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>du<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>杜牧<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>杜小月<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>度蜜月<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.haha.com<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>feng<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>凤凰台上凤凰游,凤去台空江自流,吴宫花草埋幽径,晋代衣冠成古丘<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 将本地的html文档中的数据加载到该对象中</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./test.html'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
    <span class="token comment"># print(soup)</span>
    <span class="token comment"># page_text = response.text</span>
    <span class="token comment"># soup = BeautifulSoup(page_text,'lxml')</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>a<span class="token punctuation">)</span>  <span class="token comment"># soup.tagName 返回的是html中第一次出现的tagName标签</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>div<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># find(tagName) 等同于 soup.div</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'song'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 属性定位</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回符合要求的所有标签（列表）</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回的是一个列表</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul &gt; li &gt; a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 层级选择器   &gt; 表示一个层级</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul  a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 空格表示多个层级</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul  a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul  a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul  a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>string<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.tang &gt; ul  a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-bs4-解析案例实战"><a href="#6-bs4-解析案例实战" class="headerlink" title="6. bs4 解析案例实战"></a>6. bs4 解析案例实战</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 需求：爬取三国演义小说所有的章节标题和章节内容</span>
<span class="token comment"># https://www.shicimingju.com/book/sanguoyanyi.html</span>
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#对首页的页面数据进行爬取</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.shicimingju.com/book/sanguoyanyi.html'</span>

    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>
    page_text <span class="token operator">=</span> response<span class="token punctuation">.</span>text

    <span class="token comment">#在首页中解析出章节的标题和详情页的url</span>
    <span class="token comment">#实例化BeautifulSoup对象，需要将页面源码数据加载到该对象中</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>page_text<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
    <span class="token comment"># 解析章节标题和详情页的url</span>
    li_list <span class="token operator">=</span> soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.book-mulu &gt; ul &gt; li'</span><span class="token punctuation">)</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./sanguo.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
        title <span class="token operator">=</span> li<span class="token punctuation">.</span>a<span class="token punctuation">.</span>string
        detail_url <span class="token operator">=</span><span class="token string">'http://www.shicimingju.com'</span> <span class="token operator">+</span> li<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span>
        <span class="token comment">#对详情页发起请求，解析出章节内容</span>
        detail_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> detail_url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
        detail_response<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>
        detail_page_text <span class="token operator">=</span> detail_response<span class="token punctuation">.</span>text
        <span class="token comment">#解析出详情页中相关的章节内容</span>
        detail_soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>detail_page_text<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
        div_tag <span class="token operator">=</span> detail_soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_ <span class="token operator">=</span> <span class="token string">'chapter_content'</span><span class="token punctuation">)</span>
        <span class="token comment">#解析到了章节的内容</span>
        content <span class="token operator">=</span> div_tag<span class="token punctuation">.</span>text
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>title <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token string">'爬取成功！'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-xpath解析基础"><a href="#7-xpath解析基础" class="headerlink" title="7. xpath解析基础"></a>7. xpath解析基础</h2><ul>
<li><strong>xpath解析：</strong>最常用且最便捷高效的一种解析方式。通用性。</li>
<li><strong>xpath解析原理：</strong><ul>
<li>（1）实例化一个etree的对象，且需要将被解析的页面源码数据加载到该对象中；</li>
<li>（2）调用etree对象中的xpath方法结合着xpath表达式实现标签的定位和内容的捕获。</li>
</ul>
</li>
<li><strong>环境的安装：</strong><code>pip install lxml</code>       (lxml解析器)</li>
<li><strong>如何实例化一个etree对象：</strong><code>from lxml import etree</code><ul>
<li>（1）将本地的html文档中的源码数据加载到etree对象中：<code>etree.parse(filePath)</code></li>
<li>（2）可以将从互联网上获取的源码数据加载到该对象中：<code>etree.HTML('page_text')</code></li>
</ul>
</li>
<li><strong>xpath(‘xpath表达式’)：</strong><ul>
<li>其中 / 表示从根节点定位或者表示一个层级； </li>
<li>// 表示多个层级或者从任意位置开始定位；</li>
<li>属性定位：<code>tag[@attrName="attrValue"]</code>；</li>
<li>索引定位：<code>tag[@attrName="attrValue"]/p[3]</code>，注意索引从1开始</li>
<li>取文本：<code>/text( )</code>  ：获取的是标签中直系的文本内容；<code>//text( )</code>  ：标签中非直系的文本内容（所有的文本内容）</li>
<li>取属性：<code>/@attrName   ==&gt;  img/@src</code>   </li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment">#实例化好了一个etree对象，且将被解析的源码加载到了该对象中</span>
    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span>
    <span class="token comment"># r = tree.xpath('/html/body/div')</span>
    <span class="token comment"># r = tree.xpath('/html//div')</span>
    <span class="token comment"># r = tree.xpath('//div')</span>
    <span class="token comment"># r = tree.xpath('//div[@class="song"]')</span>
    <span class="token comment"># r = tree.xpath('//div[@class="tang"]//li[5]/a/text()')[0]</span>
    <span class="token comment"># r = tree.xpath('//li[7]//text()')</span>
    <span class="token comment"># r = tree.xpath('//div[@class="tang"]//text()')</span>
    r <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="song"]/img/@src'</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-xpath实战-58二手房"><a href="#8-xpath实战-58二手房" class="headerlink" title="8. xpath实战-58二手房"></a>8. xpath实战-58二手房</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#需求：爬取58二手房中的房源信息</span>
<span class="token comment">#作者提醒：此处代码与视频课中有差别，原因是视频课拍摄时的网页源码和作者实际学习时网页源码有变化，作者代码于2021/02/26运行正常。</span>
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span> 
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">#爬取页面源码数据</span>
    url <span class="token operator">=</span> <span class="token string">'https://bj.58.com/ershoufang/'</span>
    page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    
    <span class="token comment">#数据解析</span>
    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    <span class="token comment">#存储的是标签对象</span>
    div_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//section[@class="list"]/div'</span><span class="token punctuation">)</span>
    fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'58.txt'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> div <span class="token keyword">in</span> div_list<span class="token punctuation">:</span>
        <span class="token comment">#页面数据的局部解析</span>
        title <span class="token operator">=</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/div[2]//h3/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>title <span class="token operator">+</span> <span class="token string">'\n\n'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---------------Over!------------------'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9-xpath解析案例"><a href="#9-xpath解析案例" class="headerlink" title="9. xpath解析案例"></a>9. xpath解析案例</h2><h3 id="（1）4k图片解析下载"><a href="#（1）4k图片解析下载" class="headerlink" title="（1）4k图片解析下载"></a>（1）4k图片解析下载</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#需求：解析下载图片数据 http://pic.netbian.com/4kmeinv/</span>
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> os
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'http://pic.netbian.com/4kmeinv/'</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token comment"># 手动设定响应数据的编码格式</span>
    <span class="token comment"># response.encoding = 'utf-8'</span>
    page_text <span class="token operator">=</span> response<span class="token punctuation">.</span>text

    <span class="token comment">#数据解析：src的属性值  alt属性</span>
    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    li_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="slist"]/ul/li'</span><span class="token punctuation">)</span>


    <span class="token comment">#创建一个文件夹</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./picLibs'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'./picLibs'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
        img_src <span class="token operator">=</span> <span class="token string">'http://pic.netbian.com'</span><span class="token operator">+</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/img/@src'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        img_name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/img/@alt'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'.jpg'</span>
        <span class="token comment">#通用处理中文乱码的解决方案</span>
        img_name <span class="token operator">=</span> img_name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'iso-8859-1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>

        <span class="token comment"># print(img_name,img_src)</span>
        <span class="token comment"># 请求图片进行持久化存储</span>
        img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>img_src<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        img_path <span class="token operator">=</span> <span class="token string">'picLibs/'</span><span class="token operator">+</span>img_name
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
            fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>img_name<span class="token punctuation">,</span> <span class="token string">'下载成功！！！'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------------------OVER!---------------------------------'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）全国城市名称爬取"><a href="#（2）全国城市名称爬取" class="headerlink" title="（2）全国城市名称爬取"></a>（2）全国城市名称爬取</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 需求：解析出所有城市名称  https://www.aqistudy.cn/historydata/</span>
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''headers = {
    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'
    }
    url = 'https://www.aqistudy.cn/historydata/'
    page_text = requests.get(url=url,headers=headers).text
    tree = etree.HTML(page_text)

    #数据解析
    hot_li_list = tree.xpath('//div[@class="bottom"]/ul/li')
    all_city_names = []
    #解析热门城市名字
    for li in hot_li_list:
        hot_city_names = li.xpath('./a/text()')[0]
        all_city_names.append(hot_city_names)

    #解析全部城市名字：
    city_names_list = tree.xpath('.//div[@class="bottom"]/ul/div[2]/li')
    for li in city_names_list:
        city_name = li.xpath('./a/text()')[0]
        all_city_names.append(city_name)

    print(all_city_names,len(all_city_names))'''</span>

    <span class="token comment"># 第二种方法，一起解析</span>

    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.aqistudy.cn/historydata/'</span>
    page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text

    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    <span class="token comment"># 数据解析  解析到热门城市和全部城市对应的a标签</span>
    <span class="token comment"># 热门城市标签层级div/ul/li/a</span>
    <span class="token comment"># 全部城市标签层级div/ul/div[2]/li/a</span>
    a_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="bottom"]/ul/li/a | //div[@class="bottom"]/ul/div[2]/li/a '</span><span class="token punctuation">)</span>
    all_city_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> a_list<span class="token punctuation">:</span>
        a_name <span class="token operator">=</span> a<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        all_city_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a_name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>all_city_names<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_city_names<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="10-xpath作业—爬取站长素材中免费简历模板"><a href="#10-xpath作业—爬取站长素材中免费简历模板" class="headerlink" title="10. xpath作业—爬取站长素材中免费简历模板"></a>10. xpath作业—爬取站长素材中免费简历模板</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 爬取站长素材中免费的简历模板  https://sc.chinaz.com/jianli/free.html</span>
<span class="token comment"># 代码参考：https://blog.csdn.net/nanke_nk/article/details/108966854</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./jianli'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'./jianli'</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'https://sc.chinaz.com/jianli/free_%d.html'</span>
    page <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'您一共想要爬取多少页：'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> pageNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> pageNum <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            new_url <span class="token operator">=</span> <span class="token string">'https://sc.chinaz.com/jianli/free.html'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            new_url <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token operator">%</span>pageNum<span class="token punctuation">)</span>
        page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> new_url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
        url_div_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="container"]/div'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> detail_url <span class="token keyword">in</span> url_div_list<span class="token punctuation">:</span>
            detail_url <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> detail_url<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            detail_page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> detail_url<span class="token punctuation">,</span> headers <span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
            tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>detail_page_text<span class="token punctuation">)</span>
            name <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//h1/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'iso-8859-1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            download_url <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="down"]/div[2]/ul/li[1]/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            file_path <span class="token operator">=</span> <span class="token string">'jianli/'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'.rar'</span>
            download_content <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> download_url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
                fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>download_content<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'下载完成'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-------------------------------OVER!---------------------------------------'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="四、验证码"><a href="#四、验证码" class="headerlink" title="四、验证码"></a>四、验证码</h1><h2 id="1-验证码识别简介"><a href="#1-验证码识别简介" class="headerlink" title="1. 验证码识别简介"></a>1. 验证码识别简介</h2><p><strong>验证码和爬虫之间的爱恨情仇：</strong></p>
<ul>
<li>反爬机制：验证码。识别验证码图片中的数据，用于模拟登录操作。</li>
</ul>
<p><strong>识别验证码的操作：</strong></p>
<ul>
<li>人工肉眼识别（不推荐）</li>
<li>第三方自动识别（推荐）</li>
</ul>
<h2 id="2-云打码使用流程"><a href="#2-云打码使用流程" class="headerlink" title="2. 云打码使用流程"></a>2. 云打码使用流程</h2><!--作者学习期间，该平台已经挂掉，故而使用超级鹰进行代替。同类打码平台可以自行百度选择-->

<ul>
<li>注册：用户中心身份</li>
<li>登录：用户中心身份<ul>
<li>查询余额，题分是否足够（第一次使用，绑定微信即可免费获赠1000题分；非首次使用，建议小额充值，1元即可）</li>
<li>创建软件ID——用户中心左下角</li>
<li>下载示例代码 ——开发文档</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding:utf-8</span>

<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

<span class="token keyword">class</span> <span class="token class-name">Chaojiying_Client</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> soft_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
		self<span class="token punctuation">.</span>username <span class="token operator">=</span> username
		password <span class="token operator">=</span>  password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>password <span class="token operator">=</span> md5<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>soft_id <span class="token operator">=</span> soft_id
		self<span class="token punctuation">.</span>base_params <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token string">'user'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
			<span class="token string">'pass2'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
			<span class="token string">'softid'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>soft_id<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		self<span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'Keep-Alive'</span><span class="token punctuation">,</span>
			<span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)'</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

	<span class="token keyword">def</span> <span class="token function">PostPic</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">,</span> codetype<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token triple-quoted-string string">"""
		im: 图片字节
		codetype: 题目类型 参考 http://www.chaojiying.com/price.html
		"""</span>
		params <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token string">'codetype'</span><span class="token punctuation">:</span> codetype<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		params<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_params<span class="token punctuation">)</span>
		files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'userfile'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'ccc.jpg'</span><span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">}</span>
		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://upload.chaojiying.net/Upload/Processing.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
		<span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">def</span> <span class="token function">ReportError</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token triple-quoted-string string">"""
		im_id:报错题目的图片ID
		"""</span>
		params <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token string">'id'</span><span class="token punctuation">:</span> im_id<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		params<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_params<span class="token punctuation">)</span>
		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://upload.chaojiying.net/Upload/ReportError.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
		<span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">tranformImgCode</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">,</span>imgType<span class="token punctuation">)</span><span class="token punctuation">:</span>
	chaojiying <span class="token operator">=</span> Chaojiying_Client<span class="token punctuation">(</span><span class="token string">'此处是账户'</span><span class="token punctuation">,</span> <span class="token string">'此处是密码'</span><span class="token punctuation">,</span> <span class="token string">'此处是软件ID'</span><span class="token punctuation">)</span>	<span class="token comment">#用户中心&gt;&gt;软件ID 生成一个替换 </span>
	im <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>	
	<span class="token keyword">return</span> chaojiying<span class="token punctuation">.</span>PostPic<span class="token punctuation">(</span>im<span class="token punctuation">,</span>imgType<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pic_str'</span><span class="token punctuation">]</span>	<span class="token comment">#1902 验证码类型  官方网站&gt;&gt;价格体系 3.4+版 </span>

<span class="token keyword">print</span><span class="token punctuation">(</span>tranformImgCode<span class="token punctuation">(</span><span class="token string">'./a.jpg'</span><span class="token punctuation">,</span><span class="token number">1902</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-古诗文网验证码识别"><a href="#3-古诗文网验证码识别" class="headerlink" title="3. 古诗文网验证码识别"></a>3. 古诗文网验证码识别</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">####将本部分代码复制到上一节代码之后，因为要调用上述封装的tranformImgCode方法</span>

session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 识别验证码图下载</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
<span class="token punctuation">}</span>
url <span class="token operator">=</span> <span class="token string">'https://so.gushiwen.cn/user/login.aspx?from=http://so.gushiwen.cn/user/collect.aspx'</span>
page_text <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token comment"># 解析验证码图片的地址</span>
tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
img_src <span class="token operator">=</span> <span class="token string">'https://so.gushiwen.org'</span> <span class="token operator">+</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="imgCode"]/@src'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment"># 将验证码图片保存本地</span>
img_data <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>img_src<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./code.jpg'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
	fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>

<span class="token comment"># 识别验证码</span>
code_text <span class="token operator">=</span> tranformImgCode<span class="token punctuation">(</span><span class="token string">'./code.jpg'</span><span class="token punctuation">,</span> <span class="token number">1902</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>code_text<span class="token punctuation">)</span>
login_url <span class="token operator">=</span> <span class="token string">'https://so.gushiwen.cn/user/login.aspx?from=http%3a%2f%2fso.gushiwen.cn%2fuser%2fcollect.aspx'</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string">'__VIEWSTATE'</span><span class="token punctuation">:</span> <span class="token string">'f1ECt6+6MPtdTZMJtYOYS/7ww2d/DPy9t8JQcIt1QuOneLTbNQuYqPcCjZNbDAbfb9vj3k6f0M7EKTf0YqElM1k1A5ELwyTvUzBii+9LDRBbIMmc/jb0DJPsYfI='</span><span class="token punctuation">,</span>
	<span class="token string">'__VIEWSTATEGENERATOR'</span><span class="token punctuation">:</span> <span class="token string">'C93BE1AE'</span><span class="token punctuation">,</span>
	<span class="token string">'from'</span><span class="token punctuation">:</span> <span class="token string">'http://so.gushiwen.cn/user/collect.aspx'</span><span class="token punctuation">,</span>
	<span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'账号'</span><span class="token punctuation">,</span>
	<span class="token string">'pwd'</span><span class="token punctuation">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
	<span class="token string">'code'</span><span class="token punctuation">:</span> code_text<span class="token punctuation">,</span>  <span class="token comment"># 动态变化</span>
	<span class="token string">'denglu'</span><span class="token punctuation">:</span> <span class="token string">'登录'</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token comment"># 对点击登录按钮发起请求</span>
page_text_login <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>login_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./gushiwen.html'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
	fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>page_text_login<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>在请求参数中如果看到了一组乱序的请求参数，最好去验证这组请求参数是否为动态变化</p>
<ul>
<li>处理：<ul>
<li>方式1：常规来讲一般动态变化的请求参数会被隐藏在前台页面中，那么我们就要去前台页面源码中寻找；</li>
<li>方式2：如果前台页面没有的话，我们就可以基于抓包工具进行全局搜索。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>基于百度AI实现的爬虫给功能：</strong></p>
<ul>
<li>图像识别</li>
<li>语音识别&amp;合成</li>
<li>自然语言处理</li>
</ul>
</li>
<li><p><strong>使用流程：</strong></p>
<ul>
<li><p>点击控制台进行登录</p>
</li>
<li><p>选择想要实现的功能</p>
</li>
<li><p>实现功能下创建一个app</p>
</li>
<li><p>选择对应的 pythonSDK 文档进行代码实现</p>
<blockquote>
<p>需求：<a target="_blank" rel="noopener" href="https://duanziwang.com/">https://duanziwang.com/</a></p>
<p>讲段子王中的段子内容爬取到本地，然后基于语音合成为mp3的音频文件，然后自己搭建一个web服务器，线上实时播放音频文件。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="五、requests模块高级"><a href="#五、requests模块高级" class="headerlink" title="五、requests模块高级"></a>五、requests模块高级</h1><h2 id="1-模拟登录实现流程梳理"><a href="#1-模拟登录实现流程梳理" class="headerlink" title="1. 模拟登录实现流程梳理"></a>1. 模拟登录实现流程梳理</h2><p><strong>模拟登录：</strong>爬取基于某些用户的用户信息。</p>
<p><strong>需求：</strong>对人人网进行模拟登录</p>
<ul>
<li>点击登录按钮后会发起一个post请求</li>
<li>post请求中会携带登陆之前录入的相关的登录信息（用户名、密码、验证码…….）</li>
<li>验证码：每次请求都会动态变化</li>
</ul>
<h2 id="2-人人网模拟登录"><a href="#2-人人网模拟登录" class="headerlink" title="2. 人人网模拟登录"></a>2. 人人网模拟登录</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#1. 验证码的识别,获取验证码图片的文字数据</span>
<span class="token comment">#2. 对post请求进行发送</span>
<span class="token comment">#3. 对响应数据进行持久化存储</span>

<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
url <span class="token operator">=</span> <span class="token string">'http://www.renren.com/SysHome.do'</span>
page_text <span class="token operator">=</span> response<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
code_img_src <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="verifyPic_login"]/@src'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
code_img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> code_img_src<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./code.jpg'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>code_img_data<span class="token punctuation">)</span>
    
<span class="token comment">#下面需要使用打码平台提供的示例代码进行识别，云打码平台已挂</span>
<span class="token comment">######了解视频代码使用思路即可，可自行使用其他打码平台实现操作，</span>

<span class="token comment">#post请求发送</span>
login_url <span class="token operator">=</span> <span class="token string">' '</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">=</span> login_url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">,</span>data <span class="token operator">=</span> data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>satus_code<span class="token punctuation">)</span>

<span class="token comment">#login_page_text = response.text</span>
<span class="token comment">#with open('renren.html','w',encoding = 'utf-8') #as fp:</span>
    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>login_page_text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''视频UP主的源代码'''</span>

<span class="token comment">#编码流程：</span>
<span class="token comment">#1.验证码的识别，获取验证码图片的文字数据</span>
<span class="token comment">#2.对post请求进行发送（处理请求参数）</span>
<span class="token comment">#3.对响应数据进行持久化存储</span>

<span class="token keyword">from</span> CodeClass <span class="token keyword">import</span> YDMHttp
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token comment">#封装识别验证码图片的函数</span>
<span class="token keyword">def</span> <span class="token function">getCodeText</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">,</span>codeType<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 普通用户用户名</span>
    username <span class="token operator">=</span> <span class="token string">'bobo328410948'</span>

    <span class="token comment"># 普通用户密码</span>
    password <span class="token operator">=</span> <span class="token string">'bobo328410948'</span>

    <span class="token comment"># 软件ＩＤ，开发者分成必要参数。登录开发者后台【我的软件】获得！</span>
    appid <span class="token operator">=</span> <span class="token number">6003</span>

    <span class="token comment"># 软件密钥，开发者分成必要参数。登录开发者后台【我的软件】获得！</span>
    appkey <span class="token operator">=</span> <span class="token string">'1f4b564483ae5c907a1d34f8e2f2776c'</span>

    <span class="token comment"># 图片文件：即将被识别的验证码图片的路径</span>
    filename <span class="token operator">=</span> imgPath

    <span class="token comment"># 验证码类型，# 例：1004表示4位字母数字，不同类型收费不同。请准确填写，否则影响识别率。在此查询所有类型 http://www.yundama.com/price.html</span>
    codetype <span class="token operator">=</span> codeType

    <span class="token comment"># 超时时间，秒</span>
    timeout <span class="token operator">=</span> <span class="token number">20</span>
    result <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token comment"># 检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请设置好相关参数再测试'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化</span>
        yundama <span class="token operator">=</span> YDMHttp<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> appid<span class="token punctuation">,</span> appkey<span class="token punctuation">)</span>

        <span class="token comment"># 登陆云打码</span>
        uid <span class="token operator">=</span> yundama<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'uid: %s'</span> <span class="token operator">%</span> uid<span class="token punctuation">)</span>

        <span class="token comment"># 查询余额</span>
        balance <span class="token operator">=</span> yundama<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'balance: %s'</span> <span class="token operator">%</span> balance<span class="token punctuation">)</span>

        <span class="token comment"># 开始识别，图片路径，验证码类型ID，超时时间（秒），识别结果</span>
        cid<span class="token punctuation">,</span> result <span class="token operator">=</span> yundama<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> codetype<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cid: %s, result: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>cid<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result


<span class="token comment">#1.对验证码图片进行捕获和识别</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
<span class="token punctuation">}</span>
url <span class="token operator">=</span> <span class="token string">'http://www.renren.com/SysHome.do'</span>
page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
code_img_src <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="verifyPic_login"]/@src'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
code_img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>code_img_src<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./code.jpg'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>code_img_data<span class="token punctuation">)</span>

<span class="token comment">#使用云打码提供的示例代码对验证码图片进行识别</span>
result <span class="token operator">=</span> getCodeText<span class="token punctuation">(</span><span class="token string">'code.jpg'</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">#post请求的发送（模拟登录）</span>
login_url <span class="token operator">=</span> <span class="token string">'http://www.renren.com/ajaxLogin/login?1=1&amp;uniqueTimestamp=2019431046983'</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'www.zhangbowudi@qq.com'</span><span class="token punctuation">,</span>
    <span class="token string">'icode'</span><span class="token punctuation">:</span> result<span class="token punctuation">,</span>
    <span class="token string">'origURL'</span><span class="token punctuation">:</span> <span class="token string">'http://www.renren.com/home'</span><span class="token punctuation">,</span>
    <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'renren.com'</span><span class="token punctuation">,</span>
    <span class="token string">'key_id'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token string">'captcha_type'</span><span class="token punctuation">:</span> <span class="token string">'web_login'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'06768edabba49f5f6b762240b311ae5bfa4bcce70627231dd1f08b9c7c6f4375'</span><span class="token punctuation">,</span>
    <span class="token string">'rkey'</span><span class="token punctuation">:</span> <span class="token string">'1028219f2897941c98abdc0839a729df'</span><span class="token punctuation">,</span>
    <span class="token string">'f'</span><span class="token punctuation">:</span><span class="token string">'https%3A%2F%2Fwww.baidu.com%2Flink%3Furl%3Dgds6TUs9Q1ojOatGda5mVsLKC34AYwc5XiN8OuImHRK%26wd%3D%26eqid%3D8e38ba9300429d7d000000035cedf53a'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>login_url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>

<span class="token comment"># login_page_text = response.text</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># with open('renren.html','w',encoding='utf-8') as fp:</span>
<span class="token comment">#     fp.write(login_page_text)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-模拟登录cookie操作"><a href="#3-模拟登录cookie操作" class="headerlink" title="3. 模拟登录cookie操作"></a>3. 模拟登录cookie操作</h2><ul>
<li><p><strong>需求：</strong>爬取当前用户的相关用户信息（个人主页中显示的用户信息）</p>
</li>
<li><p><strong>http/https协议：</strong>无状态。</p>
<p>  没有请求到对应页面数据的原因：发起的第二次基于个人主页页面请求的时候，服务器并不知道该次请求是基于登录状态下的请求。</p>
</li>
<li><p><strong>cookie：</strong>用来让服务器端记录客户端的相关状态</p>
<ul>
<li><p>手动处理：抓包工具获取 <code>Cookie</code> 值，将值封装到 <code>headers</code> 中（不推荐）</p>
</li>
<li><p>自动处理：</p>
<p>  <code>Cookie</code> 值的来源是哪里？模拟登录 <code>post</code> 请求后，由服务器端创建的。</p>
<p>  <code>session</code>会话对象：1. 可以进行请求的发送；2. 如果请求过程中产生了Cookie，则该Cookie会被自动存储/携带在该session对象中。</p>
<p>  创建一个<strong>session</strong>对象：<code>session = requests.Session( )</code></p>
<p>  使用<strong>session</strong>对象进行模拟登录<code>post</code>请求的发送（Cookie会被存储在session中）</p>
<p>  <strong>session</strong>对象对个人主页对应的get请求进行发送（携带了Cookie）</p>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#####基于前一节代码之上####</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#爬取当前用户的相关用户信息</span>
<span class="token triple-quoted-string string">'''手动获取Cookie（不推荐） headers = {
   ‘'Cookie':'xxxx'
    }'''</span>
detail_url <span class="token operator">=</span> <span class="token string">'http://www.renren.com/976279344/profile'</span>
detail_page_test <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> detail_url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'bobo.html'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>detail_page_test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-代理理论讲解"><a href="#4-代理理论讲解" class="headerlink" title="4. 代理理论讲解"></a>4. 代理理论讲解</h2><ul>
<li><strong>代理：</strong>破解封 IP 这种反爬机制。</li>
<li><strong>什么是代理？</strong>代理服务器。</li>
<li><strong>代理的作用：</strong><ul>
<li>突破自身 IP 被访问的限制</li>
<li>可以隐藏自身真实的 IP，免受攻击</li>
</ul>
</li>
<li><strong>相关网站：</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.kuaidaili.com/">快代理</a></li>
<li>西祠代理</li>
<li><a target="_blank" rel="noopener" href="http://www.goubanjia.com/">www.goubanjia.com</a></li>
</ul>
</li>
<li><strong>代理 ip 的类型：</strong><ul>
<li>http：只能应用到 http 协议对应的 url 中</li>
<li>https：只能应用到 https 协议对应的 url 中</li>
</ul>
</li>
<li><strong>代理ip的匿名度：</strong><ul>
<li>透明：服务器知道该次请求使用了代理，也知道请求对应的真实 ip</li>
<li>匿名：知道使用了代理，不知道真实 ip</li>
<li>高匿：不知道使用了代理，也不知道真实 ip</li>
</ul>
</li>
</ul>
<h2 id="5-代理在爬虫中的应用"><a href="#5-代理在爬虫中的应用" class="headerlink" title="5. 代理在爬虫中的应用"></a>5. 代理在爬虫中的应用</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://www.baidu.com/s?wd=ip'</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
    <span class="token punctuation">}</span>
page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">,</span> proxies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"http"</span><span class="token punctuation">:</span> <span class="token string">"http://124.205.155.153:9090"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'ip.html'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="六、高性能异步爬虫"><a href="#六、高性能异步爬虫" class="headerlink" title="六、高性能异步爬虫"></a>六、高性能异步爬虫</h1><h2 id="1-异步爬虫概述"><a href="#1-异步爬虫概述" class="headerlink" title="1. 异步爬虫概述"></a>1. 异步爬虫概述</h2><ul>
<li><p><strong>同步：</strong>不同程序单元为了完成某个任务，在执行过程中需靠某种通信方式以协调一致，称这些程序单元是同步执行的。 例如购物系统中更新商品库存，需要用 “行锁” 作为通信信号，让不同的更新请求强制排队顺序执行，那更新库存的操作是同步的。 简言之，同步意味着有序。</p>
</li>
<li><p><strong>异步：</strong>为完成某个任务，不同程序单元之间过程中无需通信协调，也能完成任务的方式，不相关的程序单元之间可以是异步的。 例如，爬虫下载网页。调度程序调用下载程序后，即可调度其他任务，而无需与该下载任务保持通信以协调行为。不同网页的下载、保存等操作都是无关的，也无需相互通知协调。这些异步操作的完成时刻并不确定。 简言之，异步意味着无序。</p>
</li>
<li><p><strong>目的：</strong>在爬虫中使用异步实现高性能的数据爬取操作。</p>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
<span class="token punctuation">}</span>
urls <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'https://downsc.chinaz.net/Files/DownLoad/jianli/202102/jianli14667.rar'</span><span class="token punctuation">,</span>
    <span class="token string">'https://downsc.chinaz.net/Files/DownLoad/jianli/202102/jianli14665.rar'</span><span class="token punctuation">,</span>
    <span class="token string">'https://downsc.chinaz.net/Files/DownLoad/jianli/202102/jianli14648.rar'</span>
<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get_content</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在爬取：'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token comment"># get方法是一个阻塞的方法</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>content

<span class="token keyword">def</span> <span class="token function">parse_content</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'响应数据的长度为：'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
    content <span class="token operator">=</span> get_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    parse_content<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-多线程and多线程"><a href="#2-多线程and多线程" class="headerlink" title="2. 多线程and多线程"></a>2. 多线程and多线程</h2><p><strong>异步爬虫的方式：</strong></p>
<ul>
<li><strong>多线程，多进程：（不建议）</strong><ul>
<li>好处：可以为相关阻塞的操作单独开启线程或者进程，阻塞操作就可以异步执行</li>
<li>弊端：无法无限制的开启多线程或者多进程</li>
</ul>
</li>
</ul>
<h2 id="3-线程池and进程池"><a href="#3-线程池and进程池" class="headerlink" title="3. 线程池and进程池"></a>3. 线程池and进程池</h2><ul>
<li><strong>线程池、进程池：（适当使用）</strong><ul>
<li>好处：可以降低系统对进程或者线程创建和销毁的一个频率，从而很好地降低系统地开销。</li>
<li>弊端：池中线程或进程地数量是有上限的。</li>
</ul>
</li>
</ul>
<h2 id="4-线程池的基本使用"><a href="#4-线程池的基本使用" class="headerlink" title="4. 线程池的基本使用"></a>4. 线程池的基本使用</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token comment">#使用单线程串行方式执行</span>
<span class="token keyword">def</span> <span class="token function">get_page</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在下载：'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载成功：'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    
name_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'xiaozi'</span><span class="token punctuation">,</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'bb'</span><span class="token punctuation">,</span><span class="token string">'cc'</span><span class="token punctuation">]</span>
start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>name_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    get_page<span class="token punctuation">(</span>name_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d second'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end_time<span class="token operator">-</span>start_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#导入线程池模块对应的类</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>dummy <span class="token keyword">import</span> Pool

<span class="token comment">#使用线程池方式执行</span>
start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_page</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在下载：'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载成功：'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span>

name_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'xiaozi'</span><span class="token punctuation">,</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'bb'</span><span class="token punctuation">,</span><span class="token string">'cc'</span><span class="token punctuation">]</span>

<span class="token comment">#实例化一个线程池对象</span>
pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>      <span class="token comment">#线程池开辟4个线程</span>
<span class="token comment">#将列表中每一个列表元素传递给get_page进行处理</span>
pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>get_page<span class="token punctuation">,</span> name_list<span class="token punctuation">)</span>

end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-线程池案例应用"><a href="#5-线程池案例应用" class="headerlink" title="5. 线程池案例应用"></a>5. 线程池案例应用</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 需求：爬取梨视频视频数据</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> os
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>dummy <span class="token keyword">import</span> Pool
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> random

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span>
<span class="token punctuation">}</span>
<span class="token comment"># 原则：线程池处理的是阻塞且耗时的操作</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 生成一个存放视频的文件夹</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./video'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'./video'</span><span class="token punctuation">)</span>
        <span class="token comment"># 对下述url发起请求解析出视频详情页的url和视频的名称</span>
    url <span class="token operator">=</span> <span class="token string">'https://www.pearvideo.com/category_5'</span>
    page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text

    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
    li_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//ul[@id="listvideoListUl"]/li'</span><span class="token punctuation">)</span>
urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储所有视频的链接和文字</span>
<span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
    detail_url <span class="token operator">=</span> <span class="token string">'https://www.pearvideo.com/'</span> <span class="token operator">+</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/a/div[2]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.mp4'</span>
    <span class="token comment"># print(detail_url,name)</span>

    <span class="token comment"># 对详情页的url发起请求</span>
    detail_page_text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>detail_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token comment"># 从详情页中解析出视频的地址</span>
    <span class="token comment">#### 视频的方法在2021/02/27 不可使用，梨视频又更改了页面源码，mp4是动态加载出来的，mp4文件经ajax请求得到，需要抓包ajax</span>
    <span class="token comment">#### 参考 https://www.cnblogs.com/qianhu/p/14027192.html的操作</span>
    detail_tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>detail_page_text<span class="token punctuation">)</span>
    name <span class="token operator">=</span> detail_tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="detailsbd"]/div[1]/div[2]/div/div[1]/h1/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    str_ <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    ajax_url <span class="token operator">=</span> <span class="token string">'https://www.pearvideo.com/videoStatus.jsp?'</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'contId'</span><span class="token punctuation">:</span> str_<span class="token punctuation">,</span>
        <span class="token string">'mrd'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ajax_headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span><span class="token punctuation">,</span>
        <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'https://www.pearvideo.com/video_'</span> <span class="token operator">+</span> str_
    <span class="token punctuation">}</span>
    dic_obj <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>ajax_url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>ajax_headers<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    video_url <span class="token operator">=</span> dic_obj<span class="token punctuation">[</span><span class="token string">"videoInfo"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'videos'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"srcUrl"</span><span class="token punctuation">]</span>

    video_true_url <span class="token operator">=</span> <span class="token string">''</span>
    s_list <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>video_url<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s_list<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            video_true_url <span class="token operator">+=</span> s_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'/'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ss_list <span class="token operator">=</span> s_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ss_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    video_true_url <span class="token operator">+=</span> <span class="token string">'cont-'</span> <span class="token operator">+</span> str_ <span class="token operator">+</span> <span class="token string">'-'</span>
                <span class="token keyword">elif</span> j <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ss_list<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    video_true_url <span class="token operator">+=</span> ss_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    video_true_url <span class="token operator">+=</span> ss_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'-'</span>
    dic <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
        <span class="token string">'url'</span><span class="token punctuation">:</span> video_true_url
    <span class="token punctuation">}</span>
    urls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dic<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_video_data</span><span class="token punctuation">(</span>dic<span class="token punctuation">)</span><span class="token punctuation">:</span>
    urll <span class="token operator">=</span> dic<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>urll<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
    path <span class="token operator">=</span> <span class="token string">'./video/'</span> <span class="token operator">+</span> dic<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.mp4'</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'正在下载.......'</span><span class="token punctuation">)</span>
    <span class="token comment"># 持久化存储操作</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token operator">+</span> <span class="token string">'.mp4'</span><span class="token punctuation">,</span> <span class="token string">'下载成功！'</span><span class="token punctuation">)</span>


<span class="token comment"># 使用线程池对视频数据进行请求（较为耗时的阻塞操作）</span>
pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>get_video_data<span class="token punctuation">,</span> urls<span class="token punctuation">)</span>

pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-协程相关概念回顾"><a href="#6-协程相关概念回顾" class="headerlink" title="6. 协程相关概念回顾"></a>6. 协程相关概念回顾</h2><ul>
<li><p><strong>协程：</strong>英文叫做 Coroutine，又称微线程，纤程，协程是一种用户态的轻量级线程。 协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈。因此协程能保留上一次调用时的状态，即所有局部状态的一个特定组合，每次过程重入时，就相当于进入上一次调用的状态。 协程本质上是个单进程，协程相对于多进程来说，无需线程上下文切换的开销，无需原子操作锁定及同步的开销，编程模型也非常简单。 我们可以使用协程来实现异步操作，比如在网络爬虫场景下，我们发出一个请求之后，需要等待一定的时间才能得到响应，但其实在这个等待过程中，程序可以干许多其他的事情，等到响应得到之后才切换回来继续处理，这样可以充分利用 CPU 和其他资源，这就是异步协程的优势。</p>
</li>
<li><p><strong>单线程+异步协程：（推荐）</strong></p>
<ul>
<li><code>event_loop：</code>事件循环，相当于一个无限循环，我们可以把一些函数注册到这个事件循环上，当满足某些条件的时候，函数就会被循环执行。</li>
<li><code>coroutine：</code>协程对象，我们可以将协程对象注册到事件循环中，它会被事件循环调用，我们可以使用 async 关键字来定义一个方法，这个方法在调用时不会立即执行，而是返回一个协程对象。</li>
<li><code>task：</code>任务，他是对协程对象的进一步封装，包含了任务的各个状态。</li>
<li><code>future：</code>代表将来执行或还没有执行的任务，实际上和 task 没有本质区别。</li>
<li><code>async：</code>定义一个协程。</li>
<li><code>await：</code>用来挂起阻塞方法的执行。</li>
</ul>
</li>
</ul>
<h2 id="7-协程相关操作回顾"><a href="#7-协程相关操作回顾" class="headerlink" title="7. 协程相关操作回顾"></a>7. 协程相关操作回顾</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url
<span class="token comment">#asyncio修饰的函数，调用之后返回的一个协程对象</span>
c <span class="token operator">=</span> request<span class="token punctuation">(</span><span class="token string">'www.baidu.com'</span><span class="token punctuation">)</span>

<span class="token comment"># #创建一个事件循环对象</span>
<span class="token comment"># loop = asyncio.get_event_loop()</span>
<span class="token comment">#</span>
<span class="token comment"># #将协程对象注册到loop中，然后启动loop</span>
<span class="token comment"># loop.run_until_complete(c)</span>

<span class="token comment"># #task的使用</span>
<span class="token comment"># loop = asyncio.get_event_loop()</span>
<span class="token comment"># #基于loop创建一个task任务对象</span>
<span class="token comment"># task = loop.create_task(c)</span>
<span class="token comment"># print(task)</span>
<span class="token comment">#</span>
<span class="token comment"># loop.run_until_complete(task)</span>
<span class="token comment"># print(task)</span>

<span class="token comment"># #future的使用</span>
<span class="token comment"># loop = asyncio.get_event_loop()</span>
<span class="token comment"># task = asyncio.ensure_future(c)</span>
<span class="token comment"># loop.run_until_complete(task)</span>
<span class="token comment"># print(task)</span>

<span class="token keyword">def</span> <span class="token function">callback_func</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#result返回的就是任务对象中封装的协程对象对应函数的返回值</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#绑定回调</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token comment">#将回调函数绑定到任务对象中</span>
task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>callback_func<span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-多任务异步协程实现"><a href="#8-多任务异步协程实现" class="headerlink" title="8. 多任务异步协程实现"></a>8. 多任务异步协程实现</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在下载'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token comment">#在异步协程中如果出现了同步模块相关的代码，那么就无法实现异步</span>
    <span class="token comment">#time.sleep(2)</span>
    <span class="token comment">#当asyncio中遇到阻塞操作，必须手动挂起</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载完毕'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
urls <span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token string">'www.baidu.com'</span><span class="token punctuation">,</span>
    <span class="token string">'www.sougou.com'</span><span class="token punctuation">,</span>
    <span class="token string">'www.goubanjia.com'</span>
<span class="token punctuation">]</span>
<span class="token comment">#任务列表：存放多个任务对象</span>
stasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
    c <span class="token operator">=</span> request<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    stasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#需要将任务列表封装到wait中</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>stasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9-aiohttp-模块引出"><a href="#9-aiohttp-模块引出" class="headerlink" title="9. aiohttp 模块引出"></a>9. aiohttp 模块引出</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">######未能实现异步进程，还是同步操作</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
urls <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'http://127.0.0.1:1080/bobo'</span><span class="token punctuation">,</span>
    <span class="token string">'http://127.0.0.1:1080/jay'</span><span class="token punctuation">,</span>
    <span class="token string">'http://127.0.0.1:1080/tom'</span>
<span class="token punctuation">]</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在下载'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token comment">#requests模块发起的请求是基于同步的，不能在异步模块中使用，否则会中断异步操作，必须使用基于异步的网络请求模块进行url的请求发送</span>
    <span class="token comment">#aiphttp模块引入</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载完毕'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
    c <span class="token operator">=</span> get_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总耗时：'</span><span class="token punctuation">,</span> end<span class="token operator">-</span>start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="10-aiohttp-多任务异步协程实现异步爬虫"><a href="#10-aiohttp-多任务异步协程实现异步爬虫" class="headerlink" title="10. aiohttp + 多任务异步协程实现异步爬虫"></a>10. aiohttp + 多任务异步协程实现异步爬虫</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#环境的安装    pip install aiohttp</span>
<span class="token comment">#使用aiohttp模块中的ClientSession</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time
<span class="token keyword">import</span> aiohttp

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
urls <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'http://www.baidu.com'</span><span class="token punctuation">,</span>
    <span class="token string">'http://www.sougou.com'</span><span class="token punctuation">,</span>
    <span class="token string">'http://www.taobao.com'</span>
<span class="token punctuation">]</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token comment">#get()、post():</span>
        <span class="token comment">#headers,params/data,proxy='http://ip:port'</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            <span class="token comment">#text()返回的是字符串形式的响应数据</span>
            <span class="token comment">#read()返回的是二进制形式的响应数据</span>
            <span class="token comment">#json()返回的是json对象</span>
            <span class="token comment">#注意：在获取响应数据操作之前，一定要使用await手动挂起</span>
            page_text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#print(page_text)</span>

tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
    c <span class="token operator">=</span> get_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总耗时：'</span><span class="token punctuation">,</span> end<span class="token operator">-</span>start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="七、动态加载数据处理"><a href="#七、动态加载数据处理" class="headerlink" title="七、动态加载数据处理"></a>七、动态加载数据处理</h1><h2 id="1-selenium简介"><a href="#1-selenium简介" class="headerlink" title="1. selenium简介"></a>1. selenium简介</h2><ul>
<li><p><strong>问题：</strong><code>selenium</code>模块和爬虫之间具有怎样的关联？</p>
<ul>
<li>便捷地获取网站中动态加载的数据</li>
</ul>
</li>
<li><p>便捷实现模拟登录</p>
</li>
<li><p><strong>什么是<code>selenium</code>模块？</strong></p>
<p>  基于浏览器自动化的一个模块。</p>
</li>
</ul>
<h2 id="2-selenium初试"><a href="#2-selenium初试" class="headerlink" title="2. selenium初试"></a>2. selenium初试</h2><p><strong>selenium使用流程：</strong></p>
<ul>
<li>环境安装：<code>pip install selenium</code></li>
<li>下载一个对应浏览器的驱动程序（以谷歌浏览器为例）<ul>
<li>下载路径：<a target="_blank" rel="noopener" href="http://npm.taobao.org/mirrors/chromedriver/%E6%88%96%E8%80%85http://chromedriver.storage.googleapis.com/index.html">http://npm.taobao.org/mirrors/chromedriver/或者http://chromedriver.storage.googleapis.com/index.html</a></li>
<li>驱动程序和浏览器的映射关系：<a target="_blank" rel="noopener" href="http://blog.csdn.net/huilan_same/article/details/51896672">http://blog.csdn.net/huilan_same/article/details/51896672</a></li>
<li>实例化一个浏览器对象</li>
<li>编写基于浏览器自动化的操作代码<ul>
<li>发起请求：<code>get(url)</code></li>
<li>标签定位：<code>find系列方法</code></li>
<li>标签交互：<code>send_keys('xxxxxx')</code></li>
<li>执行js程序：<code>excute_script('jsCode')</code></li>
<li>前进、后退：<code>forward( )、back( )</code></li>
<li>关闭浏览器：<code>quit( )</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># selenium操纵浏览器</span>
<span class="token comment">#### Tip：作者Chrome是88版本，直接下载88的chromedriver成功运行</span>

<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token comment"># 实例化一个浏览器对象（传入浏览器的驱动程序）</span>
bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">)</span>
<span class="token comment"># 让浏览器发起一个指定的url对应请求</span>
bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://scxk.nmpa.gov.cn:81/xk/'</span><span class="token punctuation">)</span>     

<span class="token comment"># 获取浏览器当前页面的页面源码数据</span>
page_text <span class="token operator">=</span> bro<span class="token punctuation">.</span>page_source

<span class="token comment"># 解析企业名称</span>
tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_text<span class="token punctuation">)</span>
li_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//ul[@id="gzlist"]/li'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
    name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./dl/@title'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-selenium其他自动化操作"><a href="#3-selenium其他自动化操作" class="headerlink" title="3. selenium其他自动化操作"></a>3. selenium其他自动化操作</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.taobao.com/'</span><span class="token punctuation">)</span>
<span class="token comment"># 标签定位</span>
search_input <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span>
<span class="token comment"># 标签的交互</span>
search_input<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'iphone'</span><span class="token punctuation">)</span>
<span class="token comment"># 执行一组js程序   相当于F12--Console执行js代码</span>
bro<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0,document.body.scrollHeight)'</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 点击搜索按钮</span>
btn <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">'.btn-search'</span><span class="token punctuation">)</span>
btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://baidu.com/'</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 回退</span>
bro<span class="token punctuation">.</span>back<span class="token punctuation">(</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 前进</span>
bro<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>

sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-iframe-处理-动作链"><a href="#4-iframe-处理-动作链" class="headerlink" title="4. iframe 处理+动作链"></a>4. iframe 处理+动作链</h2><p><code>**selenium</code>处理<code>iframe</code>：**</p>
<ul>
<li>如果定位的标签存在于iframe标签之中，则必须使用<code>switch_to.frame(id)</code></li>
<li>动作链（拖动）：<code>from selenium.webdriver import ActionChains</code><ul>
<li>实例化一个动作链对象：<code>action = ActionChains(bro)</code></li>
<li><code>click_and_hold(div)</code>：长按且点击</li>
<li><code>move_by_offset(x,y)</code></li>
<li><code>perform( )</code>：让动作链立即执行</li>
<li><code>action.release( )</code>：释放动作链对象</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token comment"># 导入动作链对应的类</span>
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains

bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">)</span>

bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.runoob.com/try/try.php?filename=jqueryui-example-droppable'</span><span class="token punctuation">)</span>

<span class="token comment"># 如果定位的标签是存在与iframe标签之中的，直接通过find方式会报错，则必须通过另外的操作来进行标签定位</span>
bro<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>frame<span class="token punctuation">(</span><span class="token string">'iframeResult'</span><span class="token punctuation">)</span>     <span class="token comment">#切换浏览器标签定位的作用域</span>
div <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'draggable'</span><span class="token punctuation">)</span>

<span class="token comment"># 动作链</span>
action <span class="token operator">=</span> ActionChains<span class="token punctuation">(</span>bro<span class="token punctuation">)</span>      <span class="token comment">#实例化动作链对象</span>
<span class="token comment"># 点击并且长按指定的标签</span>
action<span class="token punctuation">.</span>click_and_hold<span class="token punctuation">(</span>div<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#perform 表示立即执行动作链操作</span>
    <span class="token comment">#move_by_offset(x,y)   x表示水平方向，y表示竖直方向</span>
    action<span class="token punctuation">.</span>move_by_offset<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>

<span class="token comment"># 释放动作链</span>
action<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-selenium模拟登录QQ空间"><a href="#5-selenium模拟登录QQ空间" class="headerlink" title="5. selenium模拟登录QQ空间"></a>5. selenium模拟登录QQ空间</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#模拟登录QQ空间，运行前需要将代码中“QQ号码”和“QQ密码”改写</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://qzone.qq.com/'</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>frame<span class="token punctuation">(</span><span class="token string">'login_frame'</span><span class="token punctuation">)</span>

a_tag <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'switcher_plogin'</span><span class="token punctuation">)</span>
a_tag<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

userName_tag <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">)</span>
password_tag <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
userName_tag<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'QQ号码'</span><span class="token punctuation">)</span>
password_tag<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'QQ密码'</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
btn <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'login_button'</span><span class="token punctuation">)</span>
btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-无头浏览器-规避操作"><a href="#6-无头浏览器-规避操作" class="headerlink" title="6. 无头浏览器+规避操作"></a>6. 无头浏览器+规避操作</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token comment">#实现无可视化界面</span>
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token comment">#实现规避检测</span>
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ChromeOptions

<span class="token comment">#实现无可视化界面的操作</span>
chrome_options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--headless'</span><span class="token punctuation">)</span>
chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--disable-gpu'</span><span class="token punctuation">)</span>

<span class="token comment">#实现规避检测</span>
option <span class="token operator">=</span> ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
option<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'excludeSwitches'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'enable-automation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#如何实现让selenium规避被检测到的风险</span>
bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">,</span> chrome_options<span class="token operator">=</span>chrome_options<span class="token punctuation">,</span>options<span class="token operator">=</span>option<span class="token punctuation">)</span>

<span class="token comment">#无可视化界面（无头浏览器） phantomJs</span>
bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>bro<span class="token punctuation">.</span>page_source<span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-超级鹰的基本使用"><a href="#7-超级鹰的基本使用" class="headerlink" title="7. 超级鹰的基本使用"></a>7. 超级鹰的基本使用</h2><p><strong>超级鹰：</strong><a target="_blank" rel="noopener" href="https://www.chaojiying.com/about.html">https://www.chaojiying.com/about.html</a></p>
<ul>
<li>注册：普通用户</li>
<li>登录：普通用户</li>
<li>题分查询：充值</li>
<li>软件ID——创建一个软件ID</li>
<li>下载示例代码</li>
</ul>
<h2 id="8-12306模拟登录"><a href="#8-12306模拟登录" class="headerlink" title="8. 12306模拟登录"></a>8. 12306模拟登录</h2><p><strong>编码流程：</strong></p>
<ul>
<li>使用<code>selenium</code>打开登录界面</li>
<li>对当前<code>selenium</code>打开的这张界面进行截图</li>
<li>对截取的图片进行局部区域（验证码图片）的裁剪<ul>
<li>好处：将验证码图片和模拟登录进行一一对应</li>
</ul>
</li>
<li>使用超级鹰识别验证码图片（坐标）</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding:utf-8</span>

<span class="token keyword">import</span> requests
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

<span class="token comment">########下述为超级鹰示例代码</span>
<span class="token keyword">class</span> <span class="token class-name">Chaojiying_Client</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> soft_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username
        password <span class="token operator">=</span>  password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> md5<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>soft_id <span class="token operator">=</span> soft_id
        self<span class="token punctuation">.</span>base_params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'user'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            <span class="token string">'pass2'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
            <span class="token string">'softid'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>soft_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'Keep-Alive'</span><span class="token punctuation">,</span>
            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">PostPic</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">,</span> codetype<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        im: 图片字节
        codetype: 题目类型 参考 http://www.chaojiying.com/price.html
        """</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'codetype'</span><span class="token punctuation">:</span> codetype<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        params<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_params<span class="token punctuation">)</span>
        files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'userfile'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'ccc.jpg'</span><span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">}</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://upload.chaojiying.net/Upload/Processing.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">ReportError</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        im_id:报错题目的图片ID
        """</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span> im_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        params<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_params<span class="token punctuation">)</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://upload.chaojiying.net/Upload/ReportError.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">############上述为超级鹰的示例代码</span>


<span class="token comment"># 使用selenium打开登录页面</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">import</span> time
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains


bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'./chromedriver.exe'</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>execute_cdp_cmd<span class="token punctuation">(</span><span class="token string">"Page.addScriptToEvaluateOnNewDocument"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""
    Object.defineProperty(navigator, 'webdriver', {
      get: () =&gt; undefined
    })
  """</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># bro.execute_script(script)</span>
bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://kyfw.12306.cn/otn/resources/login.html'</span><span class="token punctuation">)</span>

<span class="token comment">#最大化浏览器窗口</span>
bro<span class="token punctuation">.</span>maximize_window<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 先点击选择  账号登录</span>
zhanghao_tag <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'login-hd-account'</span><span class="token punctuation">)</span>
zhanghao_tag<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># save_screenshot就是将当前页面进行截图且保存</span>
bro<span class="token punctuation">.</span>save_screenshot<span class="token punctuation">(</span><span class="token string">'aa.png'</span><span class="token punctuation">)</span>

<span class="token comment">#确定验证码图片对应的左上角和右下角的坐标（裁剪的区域就确定）</span>
code_img_ele <span class="token operator">=</span> bro<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'touclick-wrapper'</span><span class="token punctuation">)</span>
location <span class="token operator">=</span> code_img_ele<span class="token punctuation">.</span>location  <span class="token comment"># 验证码图片左上角的坐标 x,y</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'location:'</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
size <span class="token operator">=</span> code_img_ele<span class="token punctuation">.</span>size  <span class="token comment">#验证码标签对应的长和宽</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>


<span class="token comment"># 左上角和右下角坐标  #此处 *1.25 原因是作者window电脑默认显示布局为125%（电脑设置--显示--缩放与布局），不乘1.25取不到图片正确位置</span>
rangle <span class="token operator">=</span> <span class="token punctuation">(</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1.25</span><span class="token punctuation">,</span> location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1.25</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.25</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.25</span><span class="token punctuation">)</span>
<span class="token comment"># 至此验证码图片区域就确定下来了</span>

i <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./aa.png'</span><span class="token punctuation">)</span>
code_img_name <span class="token operator">=</span> <span class="token string">'./code.png'</span>

<span class="token comment"># crop根据指定区域进行图片裁剪</span>
frame <span class="token operator">=</span> i<span class="token punctuation">.</span>crop<span class="token punctuation">(</span>rangle<span class="token punctuation">)</span>
frame<span class="token punctuation">.</span>save<span class="token punctuation">(</span>code_img_name<span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>


<span class="token comment"># 将验证码图片提交给超级鹰进行识别</span>

chaojiying <span class="token operator">=</span> Chaojiying_Client<span class="token punctuation">(</span><span class="token string">'超级🦅账号'</span><span class="token punctuation">,</span> <span class="token string">'超级🦅密码'</span><span class="token punctuation">,</span> <span class="token string">'软件ID'</span><span class="token punctuation">)</span>
im <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'code.png'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>chaojiying<span class="token punctuation">.</span>PostPic<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token number">9004</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pic_str'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


result <span class="token operator">=</span> chaojiying<span class="token punctuation">.</span>PostPic<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token number">9004</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pic_str'</span><span class="token punctuation">]</span>
all_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>   <span class="token comment">#要存储即将被点击的点的坐标  [[x1,y1],[x2,y2]]</span>
<span class="token keyword">if</span> <span class="token string">'|'</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>
    list_1 <span class="token operator">=</span> result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span>
    count_1 <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>list_1<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>count_1<span class="token punctuation">)</span><span class="token punctuation">:</span>
        xy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>list_1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>list_1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        xy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        all_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xy_list<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    xy_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    xy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    xy_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    all_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xy_list<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>all_list<span class="token punctuation">)</span>
<span class="token comment"># 遍历列表，使用动作链对每一个列表元素对应的x,y指定的位置进行点击操作</span>
<span class="token keyword">for</span> l <span class="token keyword">in</span> all_list<span class="token punctuation">:</span>
    x <span class="token operator">=</span> l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">#这里的/1.25，是因为，电脑设置125%，而网页是100%的，所以，要确定网页中对应位置，除以1.25即可</span>
    ActionChains<span class="token punctuation">(</span>bro<span class="token punctuation">)</span><span class="token punctuation">.</span>move_to_element_with_offset<span class="token punctuation">(</span>code_img_ele<span class="token punctuation">,</span> x<span class="token operator">/</span><span class="token number">1.25</span><span class="token punctuation">,</span> y<span class="token operator">/</span><span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'J-userName'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'12306账号'</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'J-password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'12306密码'</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
bro<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'J-login'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># # 滑块操作，12306检测selenium,,,,滑块总是刷新重试，</span>
<span class="token comment"># action = ActionChains(bro)</span>
<span class="token comment"># try:</span>
<span class="token comment">#     slider = bro.find_element_by_css_selector('#nc_1_n1z')</span>
<span class="token comment">#     action.click_and_hold(slider)</span>
<span class="token comment">#     action.move_by_offset(300, 0).perform()</span>
<span class="token comment">#     time.sleep(15)</span>
<span class="token comment">#     action.release()</span>
<span class="token comment"># except Exception as e:</span>
<span class="token comment">#     print(e)</span>

bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="八、scrapy框架"><a href="#八、scrapy框架" class="headerlink" title="八、scrapy框架"></a>八、scrapy框架</h1><h2 id="1-scrapy框架初识"><a href="#1-scrapy框架初识" class="headerlink" title="1. scrapy框架初识"></a>1. scrapy框架初识</h2><ul>
<li><p><strong>什么是框架？</strong></p>
<p>  就是一个集成了很多功能并且具有很强通用性的一个项目模板。</p>
</li>
<li><p><strong>如何学习框架？</strong></p>
<p>  专门学习框架封装的各种功能的详细用法。</p>
</li>
<li><p><strong>什么是<code>scrapy</code>？</strong></p>
<p>  爬虫中封装好的一个明星框架。</p>
<p>  <strong>功能：</strong>高性能的持久化存储，异步的数据下载，高性能的数据解析，分布式</p>
</li>
</ul>
<h2 id="2-scrapy基本使用"><a href="#2-scrapy基本使用" class="headerlink" title="2. scrapy基本使用"></a>2. scrapy基本使用</h2><p><strong>scrapy框架的基本使用：</strong></p>
<ul>
<li>环境的安装：<ul>
<li>mac or linux：<code>pip install scrapy</code></li>
<li>windows:<ul>
<li><code>pip install wheel</code></li>
<li>下载twisted，下载地址：<a target="_blank" rel="noopener" href="http://www.lfd.uci.edu/~gohlke/pythonlibs/#twisted">http://www.lfd.uci.edu/~gohlke/pythonlibs/#twisted</a></li>
<li>安装twisted：<code>pip install Twisted-20.3.0-cp39-cp39-win_amd64.whl</code></li>
<li><code>pip install pywin32</code></li>
<li><code>pip install scrapy</code></li>
<li>测试：在终端里录入scrapy指令，没有报错即表示安装成功！</li>
</ul>
</li>
</ul>
</li>
<li>创建一个工程：<code>scrapy startproject xxxPro</code></li>
<li><code>cd xxxPro</code></li>
<li>在spiders子目录中创建一个爬虫文件<ul>
<li><code>scrapy genspider spiderName www.xxx.com</code></li>
</ul>
</li>
<li>执行工程：<ul>
<li><code>scrapy crawl spiderName</code></li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">###firstBlood__first</span>
<span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">FirstSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#爬虫文件的名称：就是爬虫源文件的一个唯一标识</span>
    name <span class="token operator">=</span> <span class="token string">'first'</span>
    <span class="token comment">#允许的域名：用来限定start_urls列表中哪些url可以进行请求发送</span>
    <span class="token comment"># allowed_domains = ['www.baidu.com']</span>

    <span class="token comment">#起始的url列表：该列表中存放的url会被scrapy自动进行请求的发送</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://www.baidu.com/'</span><span class="token punctuation">,</span> <span class="token string">'https://www.sogou.com/'</span><span class="token punctuation">]</span>

    <span class="token comment">#用作于数据解析：response参数表示的就是请求成功后对应的响应对象</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-scrapy数据解析操作"><a href="#3-scrapy数据解析操作" class="headerlink" title="3. scrapy数据解析操作"></a>3. scrapy数据解析操作</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">QiubaiSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'qiubai'</span>
    <span class="token comment">#allowed_domains = ['www.xxx.com']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://www.qiushibaike.com/text/'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#解析作者的名称+段子的内容</span>
        div_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@id="col1 old-style-col1"]/div'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> div <span class="token keyword">in</span> div_list<span class="token punctuation">:</span>
            <span class="token comment">#xpath返回的是列表，当时列表元素一定是Selector类型的对象</span>
            <span class="token comment">#extract可以将Selector对象中data参数存储的字符串提取出来</span>
            author <span class="token operator">=</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div[1]/a[2]/h2/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#列表调用了extract之后。则表示将列表中每一个Selector对象中data对应的字符串提取了出来</span>
            content <span class="token operator">=</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a[1]/div/span//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
            content <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


            <span class="token keyword">print</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-基于终端指令的持久化存储"><a href="#4-基于终端指令的持久化存储" class="headerlink" title="4. 基于终端指令的持久化存储"></a>4. 基于终端指令的持久化存储</h2><p><strong>scrapy持久化存储：</strong></p>
<ul>
<li>基于终端指令：<ul>
<li>要求：只可以将parse方法的返回值存储到本地的文本文件中</li>
<li>注意：持久化存储对应的文本文件类型只可以为：json、jsonlines、jl、csv、xml、marshal、pickle</li>
<li>指令：<code>scrapy crawl xxx -o filePath</code></li>
<li>好处：简洁高效便捷</li>
<li>缺点：局限性比较强（数据只可以存储到指定后缀的文本文件中）</li>
</ul>
</li>
</ul>
<h2 id="5-基于管道持久化存储操作"><a href="#5-基于管道持久化存储操作" class="headerlink" title="5. 基于管道持久化存储操作"></a>5. 基于管道持久化存储操作</h2><p>基于管道：</p>
<ul>
<li>编码流程：<ul>
<li>数据解析</li>
<li>在item类中定义相关的属性</li>
<li>将解析的数据封装到item类型的对象</li>
<li>将item类型的对象提交给管道进行持久化存储的操作</li>
<li>在管道类的process_item中要将其接收到的item对象中存储的数据进行持久化存储操作</li>
<li>在配置文件中开启管道</li>
</ul>
</li>
<li>好处：<ul>
<li>通用性强。</li>
</ul>
</li>
</ul>
<p><strong>面试题：将爬取到的数据一份存储到本地，一份存储到数据库，如何实现？</strong></p>
<ul>
<li>管道文件中一个管道类对应的是将数据存储到一种平台</li>
<li>爬虫文件提交的item只会给管道文件中第一个被执行的管道类接收</li>
<li><code>process_item</code>中的<code>return item</code>表示将item传递给下一个即将被执行的管道类</li>
</ul>
<h2 id="6-全站数据爬取"><a href="#6-全站数据爬取" class="headerlink" title="6. 全站数据爬取"></a>6. 全站数据爬取</h2><p><strong>基于spider的全站数据爬取：</strong>就是将网站中某板块下的全部页码对应的页面数据进行爬取。</p>
<ul>
<li>爬取：校花网明星写真的名称</li>
<li>实现方式：<ul>
<li>将所有页面的<code>url</code>添加到<code>start_urls</code>列表（不推荐）</li>
<li>自行手动进行请求发送（推荐）</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''------------校花网xiaohua.py----------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">XiaohuaSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'xiaohua'</span>
    <span class="token comment"># allowed_domains = ['www.xxx.com']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://www.521609.com/tuku/mxxz/'</span><span class="token punctuation">]</span>

    <span class="token comment">#生成一个通用的url模板(不可变)</span>
    url <span class="token operator">=</span> <span class="token string">'http://www.521609.com/tuku/mxxz/index_%d.html'</span>
    page_num <span class="token operator">=</span> <span class="token number">2</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        li_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html/body/div[4]/div[3]/ul/li'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
            img_name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>page_num <span class="token operator">&lt;=</span> <span class="token number">28</span><span class="token punctuation">:</span>
            new_url <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token operator">%</span>self<span class="token punctuation">.</span>page_num<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>page_num <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token comment">#手动请求发送:callback回调函数是专门用作于数据解析</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>new_url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>

            
<span class="token triple-quoted-string string">'''---------------校花网pipelines.py--------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define your item pipelines here</span>
<span class="token comment">#</span>
<span class="token comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="token comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span>


<span class="token keyword">class</span> <span class="token class-name">XiaohuaproPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> item
    
<span class="token triple-quoted-string string">'''----------------校花网settings.py部分代码---------------------------'''</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>
LOG_LEVEL <span class="token operator">=</span> <span class="token string">'ERROR'</span>
USER_AGENT <span class="token operator">=</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-五大核心组件"><a href="#7-五大核心组件" class="headerlink" title="7. 五大核心组件"></a>7. 五大核心组件</h2><p><strong>五大核心组件：</strong></p>
<p><img src="../PythonProjects/Typora_image/image-20210302092358486.png" alt="image-20210302092358486"></p>
<ul>
<li><strong>Spiders：</strong><ul>
<li>产生URL，对URL进行手动发送</li>
<li>进行数据解析</li>
</ul>
</li>
<li><strong>引擎（Scrapy Engine）：</strong><ul>
<li>数据流处理</li>
<li>触发事务</li>
</ul>
</li>
<li><strong>调度器（Scheduler）：</strong><ul>
<li><strong>过滤器</strong>去重</li>
<li>去重后的请求对象压到<strong>队列</strong>中</li>
</ul>
</li>
<li><strong>下载器（Downloader）：</strong><ul>
<li>负责获取页面数据并提供给引擎，而后提供给Spider</li>
</ul>
</li>
<li><strong>项目管道（Item Pipeline）：</strong><ul>
<li>负责处理爬虫从网页中抽取的实体，页面被爬虫解析所需的数据存入item后，将被发送到管道，经过特定的次序处理数据，最后存入本地文件或者数据库。</li>
</ul>
</li>
</ul>
<h2 id="8-请求传参"><a href="#8-请求传参" class="headerlink" title="8. 请求传参"></a>8. 请求传参</h2><ul>
<li><strong>使用场景：</strong>如果爬取解析的数据不在同一张页面中。（深度爬取）</li>
<li><strong>需求：</strong>爬取boss的岗位名称和岗位描述</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#### 我尝试着并未有啥结果.......等大佬</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> bossPro<span class="token punctuation">.</span>items <span class="token keyword">import</span> BossproItem

<span class="token keyword">class</span> <span class="token class-name">BossSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'boss'</span>
    <span class="token comment"># allowed_domains = ['www.xxx.com']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://www.zhipin.com/c100010000/?page=1&amp;ka=page-1'</span><span class="token punctuation">]</span>

    url <span class="token operator">=</span> <span class="token string">'https://www.zhipin.com/c100010000/?page=%d'</span>
    page_num <span class="token operator">=</span> <span class="token number">2</span>

   <span class="token comment">#回调函数接收item</span>
    <span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span>

        job_desc <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="main"]/div[3]/div/div[2]/div[2]/div[1]/div//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        job_desc <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>job_desc<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>job_desc<span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">'job_desc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> job_desc

        <span class="token keyword">yield</span> item

    <span class="token comment">#解析首页中的岗位名称</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        li_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="main"]/div/div[2]/ul/li'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
            item <span class="token operator">=</span> BossproItem<span class="token punctuation">(</span><span class="token punctuation">)</span>

            job_name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div/div[1]/div[1]/div/div[1]/span[1]/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'job_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> job_name
            <span class="token keyword">print</span><span class="token punctuation">(</span>job_name<span class="token punctuation">)</span>
            detail_url <span class="token operator">=</span> <span class="token string">'https://www.zhipin.com'</span> <span class="token operator">+</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div/div[1]/div[1]/div/div[1]/span[1]/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#对详情页发请求获取详情页的页面源码数据</span>
            <span class="token comment">#手动请求的发送</span>
            <span class="token comment">#请求传参：meta={}，可以将meta字典传递给请求对应的回调函数</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>detail_url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_detail<span class="token punctuation">,</span>meta<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span>item<span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">#分页操作</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>page_num <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>
            new_url <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token operator">%</span>self<span class="token punctuation">.</span>page_num<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>page_num <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>new_url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9-scrapy图片爬取"><a href="#9-scrapy图片爬取" class="headerlink" title="9. scrapy图片爬取"></a>9. scrapy图片爬取</h2><p><strong>图片数据爬取之ImagesPipline：</strong></p>
<ul>
<li><p>基于scrapy爬取字符串类型的数据和爬取图片类型的数据区别？</p>
<ul>
<li>字符串：只需要基于xpath进行解析且提交管道进行持久化存储</li>
<li>图片：xpath解析出图片的src属性值，单独的对图片地址发起请求获取二进制类型的数据</li>
</ul>
</li>
<li><p><strong>ImagesPipeline：</strong></p>
<ul>
<li>只需要将img的src的属性值进行解析，提交到管道，管道就会对图片的src进行请求发送获取图片的二进制类型的数据，且还会帮我们进行持久化存储。</li>
</ul>
</li>
<li><p><strong>需求：</strong>爬取站长素材的高清图片</p>
</li>
<li><p><strong>使用流程：</strong></p>
<ul>
<li>数据解析（图片的地址）</li>
<li>将存储图片地址的item提交到指定的管道类</li>
<li>在管道文件中自己定制一个基于ImagesPipeLine的一个管道类<ul>
<li><code>get_media_request( )</code></li>
<li><code>file_path</code></li>
<li><code>item_completed</code></li>
</ul>
</li>
<li>在配置文件中操作<ul>
<li>指定图片存储目录：<code>IMAGES_STORE = './imgs_ZYZhang'</code></li>
<li>指定开启的管道：自定制的管道类</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''----------------爬取站长素材高清图片  img.py-----------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> imgsPro<span class="token punctuation">.</span>items <span class="token keyword">import</span> ImgsproItem

<span class="token keyword">class</span> <span class="token class-name">ImgSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'img'</span>
    <span class="token comment"># allowed_domains = ['www.xxx.com']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://sc.chinaz.com/tupian/'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        div_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@id="container"]/div'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> div <span class="token keyword">in</span> div_list<span class="token punctuation">:</span>
            <span class="token comment">#注意：使用伪属性 src2</span>
            src <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/a/img/@src2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>

            item <span class="token operator">=</span> ImgsproItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span> <span class="token operator">=</span> src

            <span class="token keyword">yield</span> item
<span class="token triple-quoted-string string">'''----------------------爬取站长素材高清图片  pipelines.py---------------------------'''</span>            
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define your item pipelines here</span>
<span class="token comment">#</span>
<span class="token comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="token comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span>


<span class="token comment"># class ImgsproPipeline(object):</span>
<span class="token comment">#     def process_item(self, item, spider):</span>
<span class="token comment">#         return item</span>

<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>pipelines<span class="token punctuation">.</span>images <span class="token keyword">import</span> ImagesPipeline
<span class="token keyword">import</span> scrapy
<span class="token keyword">class</span> <span class="token class-name">imgsPileLine</span><span class="token punctuation">(</span>ImagesPipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment">#可以根据图片地址进行图片数据的请求</span>
    <span class="token keyword">def</span> <span class="token function">get_media_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#指定图片存储的路径</span>
    <span class="token keyword">def</span> <span class="token function">file_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        imgName <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> imgName

    <span class="token keyword">def</span> <span class="token function">item_completed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">,</span> item<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> item <span class="token comment">#返回给下一个即将被执行的管道类</span>
<span class="token triple-quoted-string string">'''---------------------------------爬取站长素材高清图片  items.py-----------------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define here the models for your scraped items</span>
<span class="token comment">#</span>
<span class="token comment"># See documentation in:</span>
<span class="token comment"># https://doc.scrapy.org/en/latest/topics/items.html</span>

<span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">ImgsproItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    src <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># pass</span>
<span class="token triple-quoted-string string">'''------------------------------爬取站长素材高清图片 setting.py部分代码-------------------'''</span>
<span class="token comment">#指定图片存储的目录</span>
IMAGES_STORE <span class="token operator">=</span> <span class="token string">'./imgs_ZYZhang'</span>
ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token string">'imgsPro.pipelines.imgsPileLine'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
LOG_LEVEL <span class="token operator">=</span> <span class="token string">'ERROR'</span>
<span class="token comment"># Crawl responsibly by identifying yourself (and your website) on the user-agent</span>
USER_AGENT <span class="token operator">=</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36'</span>

<span class="token comment"># Obey robots.txt rules</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="10-中间件"><a href="#10-中间件" class="headerlink" title="10. 中间件"></a>10. 中间件</h2><ul>
<li><strong>下载中间件：</strong><ul>
<li>位置：引擎和下载器之间</li>
<li>作用：批量拦截到整个工程中所有的请求和响应</li>
<li>拦截请求：<ul>
<li>UA伪装：<code>process_request</code></li>
<li>代理IP：<code>process_exception:return request</code></li>
</ul>
</li>
<li>拦截响应：<ul>
<li>篡改响应数据，响应对象</li>
<li>网易新闻爬取</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="11-网易新闻"><a href="#11-网易新闻" class="headerlink" title="11. 网易新闻"></a>11. 网易新闻</h2><p><strong>需求：</strong>爬取网易新闻的新闻数据（标题和内容）</p>
<ul>
<li>通过网易新闻的首页解析出几大板块对应的详情页的url（经验证，无动态加载）</li>
<li>每个板块点击后，其中的新闻标题都是动态加载出来的（动态加载）</li>
<li>通过解析出每一条新闻详情页的url，获取详情页的页面源码，解析出新闻内容</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''-------------------------------网易新闻  wangyi.py------------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> wangyiPro<span class="token punctuation">.</span>items <span class="token keyword">import</span> WangyiproItem
<span class="token keyword">class</span> <span class="token class-name">WangyiSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wangyi'</span>
    <span class="token comment"># allowed_domains = ['www.cccom']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://news.163.com/'</span><span class="token punctuation">]</span>
    models_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">#存储五个板块对应详情页的url</span>
    <span class="token comment">#解析五大板块对应详情页的url</span>

    <span class="token comment">#实例化一个浏览器对象</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>bro <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">'F:\PythonProjects\爬虫\动态加载数据处理\chromedriver.exe'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        li_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="index2016_wrap"]/div[1]/div[2]/div[2]/div[2]/div[2]/div/ul/li'</span><span class="token punctuation">)</span>
        alist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index <span class="token keyword">in</span> alist<span class="token punctuation">:</span>
            model_url <span class="token operator">=</span> li_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>models_urls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>model_url<span class="token punctuation">)</span>

        <span class="token comment">#依次对每一个板块对应的页面进行请求</span>
        <span class="token keyword">for</span> url <span class="token keyword">in</span> self<span class="token punctuation">.</span>models_urls<span class="token punctuation">:</span>      <span class="token comment">#对每一个板块的url进行请求发送</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_model<span class="token punctuation">)</span>

    <span class="token comment">#每一个板块对应的新闻标题相关的内容都是动态加载</span>
    <span class="token keyword">def</span> <span class="token function">parse_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">#解析每一个板块页面中对应新闻的标题和新闻详情页的url</span>
        <span class="token comment"># response.xpath()</span>
        div_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html/body/div/div[3]/div[4]/div[1]/div/div/ul/li/div/div'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> div <span class="token keyword">in</span> div_list<span class="token punctuation">:</span>
            title <span class="token operator">=</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[1]/h3/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            new_detail_url <span class="token operator">=</span> div<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[1]/h3/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>

            item <span class="token operator">=</span> WangyiproItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> title

            <span class="token comment">#对新闻详情页的url发起请求</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>new_detail_url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_detail<span class="token punctuation">,</span> meta<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'item'</span><span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token comment"># 解析新闻内容</span>
        content <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="content"]/div[2]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        content <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
        item <span class="token operator">=</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span>
        item<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> content

        <span class="token keyword">yield</span> item


    <span class="token keyword">def</span> <span class="token function">closed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>bro<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''-------------------------------网易新闻  pipelines.py-----------------------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define your item pipelines here</span>
<span class="token comment">#</span>
<span class="token comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="token comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span>


<span class="token keyword">class</span> <span class="token class-name">WangyiproPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">return</span> item
<span class="token triple-quoted-string string">'''-------------------------------网易新闻  middlewares.py-------------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define here the models for your spider middleware</span>
<span class="token comment">#</span>
<span class="token comment"># See documentation in:</span>
<span class="token comment"># https://doc.scrapy.org/en/latest/topics/spider-middleware.html</span>

<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> signals


<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> HtmlResponse
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token keyword">class</span> <span class="token class-name">WangyiproDownloaderMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Not all methods need to be defined. If a method is not defined,</span>
    <span class="token comment"># scrapy框架 acts as if the downloader middleware does not modify the</span>
    <span class="token comment"># passed objects.</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Called for each request that goes through the downloader</span>
        <span class="token comment"># middleware.</span>

        <span class="token comment"># Must either:</span>
        <span class="token comment"># - return None: continue processing this request</span>
        <span class="token comment"># - or return a Response object</span>
        <span class="token comment"># - or return a Request object</span>
        <span class="token comment"># - or raise IgnoreRequest: process_exception() methods of</span>
        <span class="token comment">#   installed downloader middleware will be called</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># 通过该方法拦截五大板块对应的响应对象，进行篡改，使其满足需求</span>
    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">#spider爬虫对象</span>
        bro <span class="token operator">=</span> spider<span class="token punctuation">.</span>bro  <span class="token comment">#获取了在爬虫类中定义的浏览器对象</span>

        <span class="token comment">#挑选出指定的响应对象进行篡改</span>
        <span class="token comment">#    通过url指定request</span>
        <span class="token comment">#    通过request指定response</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>url <span class="token keyword">in</span> spider<span class="token punctuation">.</span>models_urls<span class="token punctuation">:</span>
            bro<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>   <span class="token comment">#五个板块对应的url进行请求</span>
            sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            page_text <span class="token operator">=</span> bro<span class="token punctuation">.</span>page_source  <span class="token comment">#包含了动态加载的新闻数据</span>

            <span class="token comment">#response #五大板块对应的响应对象</span>
            <span class="token comment">#针对定位到的这些response进行篡改</span>
            <span class="token comment">#实例化一个新的响应对象（符合需求：包含动态加载出的新闻数据），替代原来旧的响应对象</span>
            <span class="token comment">#如何获取动态加载出的新闻数据？</span>
                <span class="token comment">#基于selenium便捷的获取动态加载数据</span>
            new_response <span class="token operator">=</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> body<span class="token operator">=</span>page_text<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> request<span class="token operator">=</span>request<span class="token punctuation">)</span>

            <span class="token keyword">return</span> new_response
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment">#response #其他请求对应的响应对象</span>
            <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Called when a download handler or a process_request()</span>
        <span class="token comment"># (from other downloader middleware) raises an exception.</span>

        <span class="token comment"># Must either:</span>
        <span class="token comment"># - return None: continue processing this exception</span>
        <span class="token comment"># - return a Response object: stops process_exception() chain</span>
        <span class="token comment"># - return a Request object: stops process_exception() chain</span>
        <span class="token keyword">pass</span>
<span class="token triple-quoted-string string">'''-----------------------------网易新闻 setting.py部分代码---------------------------------'''</span>
<span class="token comment">#USER_AGENT = 'wangyiPro (+http://www.yourdomain.com)'</span>
USER_AGENT <span class="token operator">=</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36'</span>

<span class="token comment"># Obey robots.txt rules</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment"># Enable or disable downloader middlewares</span>
<span class="token comment"># See https://doc.scrapy.org/en/latest/topics/downloader-middleware.html</span>
DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token string">'wangyiPro.middlewares.WangyiproDownloaderMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token string">'wangyiPro.pipelines.WangyiproPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
LOG_LEVEL <span class="token operator">=</span> <span class="token string">'ERROR'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="12-CrawlSpider的全站数据爬取"><a href="#12-CrawlSpider的全站数据爬取" class="headerlink" title="12. CrawlSpider的全站数据爬取"></a>12. CrawlSpider的全站数据爬取</h2><p><strong>CrawlSpider：</strong>基于Spider的一个子类</p>
<ul>
<li>全站数据爬取的方式<ul>
<li>基于Spider：手动请求发送</li>
<li>基于CrawlSpider</li>
</ul>
</li>
<li>CrawlSpider的使用：<ul>
<li>创建一个工程</li>
<li>cd  XXX</li>
<li>创建爬虫文件（CrawlSpider）<ul>
<li><code>scrapy  genspider  -t  crawl  xxx   www.xxxx.com</code></li>
<li><strong>链接提取器（LinkExtractor）：</strong>根据指定规则（allow=”正则”）进行指定链接的提取</li>
<li><strong>规则解析器（Rule）：</strong>将链接提取器提取到的链接进行指定规则（callback）的解析操作</li>
</ul>
</li>
</ul>
</li>
<li><strong>需求：</strong>爬取阳光热线网站中的编号，新闻标题，新闻内容，标号<ul>
<li>分析：爬取的数据没有在同一张页面中</li>
<li><ol>
<li>可以使用链接提取器提取所有的页码链接</li>
<li>让链接提取器提取所有的问政详情页链接</li>
</ol>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''---------------------阳光问政    sun.py---------------------------'''</span>
<span class="token triple-quoted-string string">'''网站页面源码跟视频课有改动，建议follow先改False爬一下，不然容易被封IP，有兴趣的可以改改，搞个代理啥的再爬'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>linkextractors <span class="token keyword">import</span> LinkExtractor
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> CrawlSpider<span class="token punctuation">,</span> Rule
<span class="token keyword">from</span> sunPro<span class="token punctuation">.</span>items <span class="token keyword">import</span> SunproItem<span class="token punctuation">,</span> DetailItem

<span class="token comment"># 需求：爬取阳光热线网站中的编号，新闻标题，新闻内容，标号</span>
<span class="token keyword">class</span> <span class="token class-name">SunSpider</span><span class="token punctuation">(</span>CrawlSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'sun'</span>
    <span class="token comment"># allowed_domains = ['www.xxx.com']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://wz.sun0769.com/political/index/politicsNewest?id=1&amp;page='</span><span class="token punctuation">]</span>

    <span class="token comment">#链接提取器：根据指定规则（allow="正则"）进行指定链接的提取</span>
    link <span class="token operator">=</span> LinkExtractor<span class="token punctuation">(</span>allow<span class="token operator">=</span><span class="token string">r'id=1&amp;page=\d+'</span><span class="token punctuation">)</span>
    link_detail <span class="token operator">=</span> LinkExtractor<span class="token punctuation">(</span>allow<span class="token operator">=</span><span class="token string">r'index\?id=\d+'</span><span class="token punctuation">)</span>
    rules <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token comment">#规则解析器：将链接提取器提取到的链接进行指定规则（callback）的解析操作</span>
        Rule<span class="token punctuation">(</span>link<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token string">'parse_item'</span><span class="token punctuation">,</span> follow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">#follow=True：可以将链接提取器 继续作用到 链接提取器提取到的链接 所对应的页面中</span>
        Rule<span class="token punctuation">(</span>link_detail<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token string">'parse_detail'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">#http://wz.sun0769.com/political/politics/index?id=490505</span>
    <span class="token comment">#http://wz.sun0769.com/political/politics/index?id=490504</span>

    <span class="token comment"># 解析新闻编号和新闻的标题</span>
    <span class="token comment"># 如下两个解析方法中是不可以实现请求传参！</span>
    <span class="token comment"># 无法将两个解析方法解析的数据存储到同一个item中，可以依次存储到两个item中</span>
    <span class="token keyword">def</span> <span class="token function">parse_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#注意：xpath表达式中不可以出现tbody标签</span>
        li_list <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html//div[2]/div[3]/ul[2]/li'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> li <span class="token keyword">in</span> li_list<span class="token punctuation">:</span>
            new_num <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./span[1]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            new_title <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./span[3]/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>

            item <span class="token operator">=</span> SunproItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_title
            item<span class="token punctuation">[</span><span class="token string">'new_num'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_num

            <span class="token keyword">yield</span> item

    <span class="token comment">#解析新闻内容和新闻编号</span>
    <span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        new_id <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html//div[3]/div[2]/div[2]/div[1]/span[4]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        new_content <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html//div[3]/div[2]/div[2]/div[2]/pre/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        new_content <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_content<span class="token punctuation">)</span>

        <span class="token comment"># print(new_id,new_content)</span>
        item <span class="token operator">=</span> DetailItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_content
        item<span class="token punctuation">[</span><span class="token string">'new_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_id

        <span class="token keyword">yield</span> item
        
<span class="token triple-quoted-string string">'''-------------------------------pipelines.py------------------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define your item pipelines here</span>
<span class="token comment">#</span>
<span class="token comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="token comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span>


<span class="token keyword">class</span> <span class="token class-name">SunproPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#如何判定item的类型</span>
        <span class="token comment">#将数据写入数据库时，如何保证数据的一致性</span>
        <span class="token keyword">if</span> item<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__ <span class="token operator">==</span> <span class="token string">'DetailItem'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'new_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'new_num'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item
    
<span class="token triple-quoted-string string">'''---------------------------items.py----------------------'''</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token comment"># Define here the models for your scraped items</span>
<span class="token comment">#</span>
<span class="token comment"># See documentation in:</span>
<span class="token comment"># https://doc.scrapy.org/en/latest/topics/items.html</span>

<span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">SunproItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    new_num <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DetailItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_id <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-分布式概述及搭建"><a href="#13-分布式概述及搭建" class="headerlink" title="13. 分布式概述及搭建"></a>13. 分布式概述及搭建</h2><p><strong>分布式爬虫：</strong></p>
<ul>
<li>概念：我们需要搭建一个分布式的机群，让其对一组资源进行分布联合爬取。</li>
<li>作用：提升爬取数据的效率</li>
</ul>
<p><strong>如何实现分布式？</strong></p>
<ul>
<li>安装一个scrapy-redis的组件</li>
<li>原生的scrapy是不可以实现分布式爬虫的，必须要让scrapy-redis组件一起实现分布式爬虫。</li>
</ul>
<p><strong>为什么原生的scrapy不可以实现分布式？</strong></p>
<ul>
<li>调度器不可以被分布式机群共享</li>
<li>管道不可以被分布式机群共享</li>
</ul>
<p><strong>scrapy-redis组件作用：</strong></p>
<ul>
<li>可以给原生的scrapy框架提供可以被共享的<em>管道</em>和<em>调度器</em>。</li>
</ul>
<p><strong>scrapy-redis实现流程：</strong></p>
<ul>
<li><p>创建一个工程</p>
</li>
<li><p>创建一个基于CrawlSpider的爬虫文件</p>
</li>
<li><p>修改当前的爬虫文件：</p>
<ul>
<li>导包：<code>from scrapy_redis.spiders  import  RedisCrawlSpider</code></li>
<li>将start_urls和allowed_domains进行注释</li>
<li>添加一个新属性：redis_key = ‘   ‘ 可以被共享的调度器队列的名称</li>
<li>编写数据解析相关的操作</li>
<li>将当前爬虫类的父类修改成 RedisCrawlSpider</li>
</ul>
</li>
<li><p>修改配置文件settings</p>
<ul>
<li><p>指定使用可以被共享的管道：</p>
</li>
<li><p>`ITEM_PIPELINES = {</p>
<pre><code>  'scrapy_redis.pipelines.RedisPipeline': 400 }`
</code></pre>
</li>
<li><p>指定调度器：</p>
</li>
<li><p>增加了一个去重容器类的配置，作用是用Redis的set集合来存储请求的指纹数据，从而实现请求去重的持久化</p>
<p>  <code>DUPEFILTER_CLASS = "scrapy_redis.dupefilter.RFPDupeFilter"</code></p>
<p>  使用scrapy-redis组件自己的调度器</p>
<p>  <code>SCHEDULER = "scrapy_redis.scheduler.Scheduler"</code></p>
<p>  配置调度器是否要持久化，也就是当爬虫结束了，要不要清空Redis中请求队列和去重指纹的set。如果是True，就表示要持久化存储，就不清数据，否则清空数据</p>
<p>  <code>SCHEDULER_PERSIST = True</code></p>
</li>
<li><p>指定redis服务器</p>
</li>
</ul>
</li>
<li><p>redis相关操作配置：</p>
<ul>
<li>配置redis的配置文件：<ul>
<li>linux或者mac：<code>redis.conf</code></li>
<li>windows：<code>redis.windows.conf</code></li>
<li>打开配置文件修改：<ul>
<li>将<code>bind 127.0.0.1</code>进行注释或删除</li>
<li>关闭保护模式：<code>protected-mode yes</code>改为no</li>
</ul>
</li>
</ul>
</li>
<li>结合着配置文件开启redis服务<ul>
<li>redis-server 配置文件</li>
<li>启动客户端：redis-cli</li>
</ul>
</li>
</ul>
</li>
<li><p>执行工程：</p>
<ul>
<li><code>scrapy  runspider  xxx.py</code></li>
</ul>
</li>
<li><p>向调度器的队列中放入一个起始的url：</p>
<ul>
<li>调度器的队列在redis的客户端中</li>
<li><code>lpush  xxx  www.xxx.com</code></li>
</ul>
</li>
<li><p>爬取到的数据存储在了 redis 的 <code>proName:items</code> 这个数据结构中</p>
</li>
</ul>
<h2 id="14-增量式爬虫"><a href="#14-增量式爬虫" class="headerlink" title="14. 增量式爬虫"></a>14. 增量式爬虫</h2><ul>
<li><strong>概念：</strong>监测网站数据更新的情况，只会爬取网站最新更新出来的数据。</li>
<li><strong>分析：</strong><ul>
<li>指定一个起始url</li>
<li>基于CrawlSpider获取其他页码链接</li>
<li>基于Rule将其他页码链接进行请求</li>
<li>从每一个页码对应的页面源码中解析出每一个电影详情页的URL</li>
<li>核心：检测电影详情页的url之前有没有请求过<ul>
<li>将爬取过的电影详情页的url存储</li>
<li>存储到redis的set数据结构</li>
</ul>
</li>
<li>对详情页的url发起请求，然后解析出电影的名称和简介</li>
<li>进行持久化存储</li>
</ul>
</li>
</ul>
<hr>
<h1 id="九、补充——异步编程"><a href="#九、补充——异步编程" class="headerlink" title="九、补充——异步编程"></a>九、补充——异步编程</h1><p><strong>为什么要讲？</strong></p>
<ul>
<li>这一部分的知识点不太容易学习（异步非阳塞、 asyncio）</li>
<li>异步相关话题和框架越来越多，例如：tornado、fastapi、django 3.x asgi、aiohttp都在异步→提升性能</li>
</ul>
<p><strong>如何讲解？</strong></p>
<ul>
<li>第一部分：协程</li>
<li>第二部分：asyncio模块进行异步编程</li>
<li>第三部分：实战案例</li>
</ul>
<h2 id="1-协程"><a href="#1-协程" class="headerlink" title="1. 协程"></a>1. 协程</h2><p>协程不是计算机提供，程序员人为创造。</p>
<p>协程（ Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
func1<span class="token punctuation">(</span><span class="token punctuation">)</span>
func2<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>实现协程的集中方法：</strong></p>
<ul>
<li>greelet，早期模块</li>
<li>yield关键字</li>
<li>asyncio装饰器（py3.4及以后版本）</li>
<li>async、await关键字（py3.5及以后版本）</li>
</ul>
<h3 id="（1）greenlet实现协程"><a href="#（1）greenlet实现协程" class="headerlink" title="（1）greenlet实现协程"></a>（1）greenlet实现协程</h3><p><code>pip install greenlet</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> greenlet <span class="token keyword">import</span> greenlet
<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    gr2<span class="token punctuation">.</span>switch<span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">#切换到func2函数</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    gr2<span class="token punctuation">.</span>switch<span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">#切换到func2函数，从上一次执行的位置继续向后执行</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    gr1<span class="token punctuation">.</span>switch<span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">#切换到func1函数，从上一次执行的位置继续向后执行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
gr1 <span class="token operator">=</span> greenlet<span class="token punctuation">(</span>func1<span class="token punctuation">)</span>
gr2 <span class="token operator">=</span> greenlet<span class="token punctuation">(</span>func2<span class="token punctuation">)</span>
gr1<span class="token punctuation">.</span>switch<span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">#去执行func1函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）yield关键字"><a href="#（2）yield关键字" class="headerlink" title="（2）yield关键字"></a>（2）yield关键字</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token number">1</span>
    <span class="token keyword">yield</span> <span class="token keyword">from</span> func2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token number">2</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token number">3</span>
    <span class="token keyword">yield</span> <span class="token number">4</span>
f1 <span class="token operator">=</span> func1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> f1<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）asyncio装饰器"><a href="#（3）asyncio装饰器" class="headerlink" title="（3）asyncio装饰器"></a>（3）asyncio装饰器</h3><p>==遇到IO阻塞自动切换==</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>
<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>		<span class="token comment">#遇到IO耗时操作，自动化切换到tasks中的其他任务</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>		<span class="token comment">#遇到IO耗时操作，自动化切换到tasks中的其他任务</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>func1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>func2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（4）async、await关键字（推荐）"><a href="#（4）async、await关键字（推荐）" class="headerlink" title="（4）async、await关键字（推荐）"></a>（4）async、await关键字（推荐）</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>		<span class="token comment">#遇到IO耗时操作，自动化切换到tasks中的其他任务</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>		<span class="token comment">#遇到IO耗时操作，自动化切换到tasks中的其他任务</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    
tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>func1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>func2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-协程的意义"><a href="#2-协程的意义" class="headerlink" title="2. 协程的意义"></a>2. 协程的意义</h2><p>在一个线程中，如果遇到IO等待的时间，线程不会等待，利用空闲的时间去做其他的事情。</p>
<p>需求：下载三张图片（网络IO）</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''普通的request方式'''</span>
<span class="token keyword">import</span> requests

<span class="token keyword">def</span> <span class="token function">download_image</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载：'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载完成'</span><span class="token punctuation">)</span>

    file_name <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file_object<span class="token punctuation">:</span>
        file_object<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    url_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/210302/000706-1614614826df15.jpg'</span><span class="token punctuation">,</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/210228/010301-1614445381005c.jpg'</span><span class="token punctuation">,</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/190902/152344-1567409024af8c.jpg'</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> url_list<span class="token punctuation">:</span>
        download_image<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''使用aiohttp模块下载    协程方式'''</span>
<span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'发送请求：'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> verify_ssl <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file_object<span class="token punctuation">:</span>
            file_object<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载完成'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        url_list <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string">'https://pic.netbian.com/uploads/allimg/210302/000706-1614614826df15.jpg'</span><span class="token punctuation">,</span>
            <span class="token string">'https://pic.netbian.com/uploads/allimg/210228/010301-1614445381005c.jpg'</span><span class="token punctuation">,</span>
            <span class="token string">'https://pic.netbian.com/uploads/allimg/190902/152344-1567409024af8c.jpg'</span>
        <span class="token punctuation">]</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> url_list<span class="token punctuation">]</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#asyncio.run(main())     #正常运行但是会报错,换成loop方式就ok</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-异步编程"><a href="#3-异步编程" class="headerlink" title="3. 异步编程"></a>3. 异步编程</h2><h3 id="（1）事件循环"><a href="#（1）事件循环" class="headerlink" title="（1）事件循环"></a>（1）事件循环</h3><p><strong>概念：</strong>理解为一个死循环，去检测并执行某些代码。</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 伪代码</span>
任务列表 = [任务1 , 任务2 , 任务3 ....]
while True:
	可执行的任务列表，已完成的任务列表--&gt;去任务列表中检测所有的任务，将“可执行”和“已完成”的任务返回
	for 就绪任务 in 可执行的任务列表:
		执行已就绪的任务
    for 已完成的任务 in 已完成的任务列表:
    	在任务列表中移除 已完成的任务
    如果 任务列表 中的任务都已经完成，则终止循环。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token comment"># 去生成或获取一个事件循环</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 将任务task放到 任务列表</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）快速上手"><a href="#（2）快速上手" class="headerlink" title="（2）快速上手"></a>（2）快速上手</h3><p><strong>协程函数：</strong>定义函数时 <code>async def 函数名</code></p>
<p><strong>协程对象：</strong>执行 协程函数 得到的对象</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<!--注意：执行协程函数创建协程对象，函数内部代码不会执行！-->

<!--如果想要运行协程函数内部代码，必须要将协程代码交给事件循环来处理。-->

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'快来打我吧！'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">#asyncio.run(result)		#python3.7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）await关键字"><a href="#（3）await关键字" class="headerlink" title="（3）await关键字"></a>（3）await关键字</h3><p><code>await 可等待的对象(协程对象、Future对象、Task对象)</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例一'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'来玩呀'</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例二'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">others</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'返回值'</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'执行协程函数内部代码'</span><span class="token punctuation">)</span>

    <span class="token comment">#遇到IO操作挂起当前协程（任务），等IO操作完成以后再继续往下执行，当前协程挂起时，事件循环可以去执行其他区协程（任务</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> others<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'IO请求结束，结果为：'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例三'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">others</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'返回值'</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'执行协程函数内部代码'</span><span class="token punctuation">)</span>

    <span class="token comment">#一个协程函数中可以有多个await关键字</span>
    response1 <span class="token operator">=</span> <span class="token keyword">await</span> others<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'IO请求结束，结果为：'</span><span class="token punctuation">,</span> response1<span class="token punctuation">)</span>

    response2 <span class="token operator">=</span> <span class="token keyword">await</span> others<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'IO请求结束，结果为：'</span><span class="token punctuation">,</span> response2<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<!--await就是等待对象的值得到结果之后再继续向下走。-->

<h3 id="（4）Task对象"><a href="#（4）Task对象" class="headerlink" title="（4）Task对象"></a>（4）Task对象</h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html?highlight=task#asyncio.Task">Task对象官方文档</a></p>
<p><strong>主要就是在事件循环中添加多个任务。</strong></p>
<p>Task 用于并发调度协程，<code>通过asyncio.create_task(协程对象)</code> 的方式创建 Task 对象，这样可以让协程加入事件循环中等待被调度执行。除了使用 <code>asyncio.create_task()</code> 函数之外，还可以使用低层级的 <code>loop.create_task()</code> 或者 <code>ensure_future()</code> 函数，不建议手动实例化 Task 对象</p>
<!--注意：asyncio.create_task() 函数在 Python 3.7 中被加入，在Python 3.7之前，可以改用低层级的 asyncio.ensure_future() 函数。-->

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例1'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'返回值'</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'main开始'</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建Task对象，将当前执行func函数任务添加到事件循环</span>
    task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建Task对象，将当前执行func函数任务添加到事件循环</span>
    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'main结束'</span><span class="token punctuation">)</span>
    <span class="token comment"># 当执行某协程遇到IO操作时，会自动华切换执行其他任务</span>
    <span class="token comment"># 此处的 await 是等待相对应的协程全部执行完毕并获取结果</span>
    ret1 <span class="token operator">=</span> <span class="token keyword">await</span> task1
    ret2 <span class="token operator">=</span> <span class="token keyword">await</span> task2
    <span class="token keyword">print</span><span class="token punctuation">(</span>ret1<span class="token punctuation">,</span>ret2<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例2'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'返回值'</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'main开始'</span><span class="token punctuation">)</span>
    
    task_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'n1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'n2'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>	<span class="token comment">#多个任务，更常使用列表形式</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'main结束'</span><span class="token punctuation">)</span>    
    
    done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
    
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>			<span class="token comment">#loop事件循环首先创建，然后列表才创建进去</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例3'''</span>
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'返回值'</span>

<span class="token comment">#使用这段代码会报错，因为列表里的代码会立即加到事件循环中去，但是此时事件循环还没有创建</span>
<span class="token comment"># task_list = [</span>
<span class="token comment">#     asyncio.create_task(func(), name='n1'),</span>
<span class="token comment">#     asyncio.create_task(func(), name='n2')</span>
<span class="token comment"># ]</span>
task_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    func<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

done<span class="token punctuation">,</span> pending <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（5）asyncio-Future对象"><a href="#（5）asyncio-Future对象" class="headerlink" title="（5）asyncio.Future对象"></a>（5）asyncio.Future对象</h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/asyncio-future.html?highlight=future#asyncio.Future">asyncio.Future官方文档</a></p>
<p><strong>Task 对象继承 Future，Task 对象内部 await 结果的处理是基于 Future 对象来的。</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例1'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取当前事件循环</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建一个任务（Future对象），这个任务什么都不干</span>
    fut <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#  等待任务最终的结果（Future对象）,没有结果则会一直等下去。</span>
    <span class="token keyword">await</span> fut

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例2'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">set_after</span><span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    fut<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token string">'666'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#的获取当前事件循环</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建一个任务（Task对象），绑定了set_after函数，函数内部在2s之后，会给fut赋值</span>
    <span class="token comment"># 即手动设置future任务的最终结果，那么fut就可以结束了</span>
    <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>set_after<span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 等待 future 对象获取最终结果，否则会一直等下去</span>
    data <span class="token operator">=</span> <span class="token keyword">await</span> fut
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（6）concurrent-futures-Future对象"><a href="#（6）concurrent-futures-Future对象" class="headerlink" title="（6）concurrent.futures.Future对象"></a>（6）concurrent.futures.Future对象</h3><p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/concurrent.futures.html?highlight=future#module-concurrent.futures">concurrent.futures官方文档</a></p>
<p><strong>使用进程池或者线程池实现异步操作时用到的对象。</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> Future
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>thread <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>process <span class="token keyword">import</span> ProcessPoolExecutor

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    
<span class="token comment"># 创建线程池</span>
pool <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">#创建进程池</span>
<span class="token comment">#  pool = ProcessPoolExecutor(max_workers = 5)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fut <span class="token operator">=</span> pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>func<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以后写代码或许还有交叉使用。例如：crm项目80%都是属于基于协程异步编程 + MySQL（不支持）【线程或者进程做异步编程】</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures

<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 某个耗时操作</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"SB"</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 1.Run is the default loop's executor(默认ThreadPoolExecutor)</span>
    <span class="token comment"># step1 ：内部调用ThreadPoolExecutor 的 submit 方法去线程池中申请一个线程去执行 func1 函数，并返回一个 concurrent.futures.Future 对象</span>
    <span class="token comment"># step2 ：调用asyncio.wrap_future 将 concurrent.futures.Future 对象包装为 asyncio.Future 对象</span>
    <span class="token comment"># 因为 concurrent.futures.Future 对象不支持 await 语法，所以需要包装为 asyncio.Future 对象，才可以使用</span>
    fut <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> func1<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> fut
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'default thread pool'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token comment"># 2.Run in a custom thread pool:</span>
    <span class="token comment"># with concurrent.futures.ThreadPoolExecutor() as pool:</span>
    <span class="token comment"># result = await loop.run_in_executor(pool,func1)</span>
    <span class="token comment"># print('custom thread pool',result)</span>

    <span class="token comment"># 3.Run in a custom process pool:</span>
    <span class="token comment"># with concurrent.futures.ThreadPoolExecutor() as pool:</span>
    <span class="token comment"># result = await loop.run_in_executor(pool,func1)</span>
    <span class="token comment"># print('custom process pool',result)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（7）案例：asyncio-不支持异步的模块"><a href="#（7）案例：asyncio-不支持异步的模块" class="headerlink" title="（7）案例：asyncio + 不支持异步的模块"></a>（7）案例：asyncio + 不支持异步的模块</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 跟前一节代码一样的效果，但是更耗费资源</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">download_image</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 发送网络请求，下载图片（遇到网络下载图片的IO请求，自动化切换到其他任务）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>

    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># requests模块默认不支持异步操作，所以就使用线程池来配合实现了</span>
    future <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">,</span> url<span class="token punctuation">)</span>

    response <span class="token operator">=</span> <span class="token keyword">await</span> future
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'下载完成'</span><span class="token punctuation">)</span>
    <span class="token comment"># 图片保存到本地文件</span>
    file_name <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file_object<span class="token punctuation">:</span>
        file_object<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    url_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/210302/000706-1614614826df15.jpg'</span><span class="token punctuation">,</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/200910/200207-1599739327e5a8.jpg'</span><span class="token punctuation">,</span>
        <span class="token string">'https://pic.netbian.com/uploads/allimg/190902/152344-1567409024af8c.jpg'</span>
    <span class="token punctuation">]</span>

    tasks <span class="token operator">=</span> <span class="token punctuation">[</span>download_image<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> url_list<span class="token punctuation">]</span>

    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（8）异步迭代器"><a href="#（8）异步迭代器" class="headerlink" title="（8）异步迭代器"></a>（8）异步迭代器</h3><p><strong>什么是异步迭代器？</strong></p>
<p>实现了 <code>__aiter__()</code> 和 <code>__anext__()</code> 方法的对象。<code>__anext__() </code>必须返回一个 <code>awaitable</code> 对象。<code>async for</code> 会处理异步迭代器的 <code>__anext__() </code> 方法所返回的可等待对象，直到其引发一个 <code>StopAsyncIteration</code> 异常。由 <code>PEP 492</code> 引入。</p>
<p><strong>什么是异步可迭代对象？</strong><br>可在 <code>async for</code> 语句中被使用的对象。必须通过它的 <code>__aiter__()</code> 方法返回一个 <code>asynchronous iterator</code>。由 <code>PEP 492</code> 引入。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">class</span> <span class="token class-name">Reader</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''自定义异步迭代器 （同时也是一部可迭代对象）'''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">readline</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># await asyncio.sleep(1)</span>
        self<span class="token punctuation">.</span>count  <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count

    <span class="token keyword">def</span> <span class="token function">__aiter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__anext__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        val <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> StopAsyncIteration
        <span class="token keyword">return</span> val

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> Reader<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> obj<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（9）异步上下文管理器"><a href="#（9）异步上下文管理器" class="headerlink" title="（9）异步上下文管理器"></a>（9）异步上下文管理器</h3><p>此种对象通过定义 <code>__aenter__()</code> 和 <code>__aexit__()</code> 方法来对 <code>async with</code> 语句中的环境进行控制。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">class</span> <span class="token class-name">AsyncContextManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> conn

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 异步操作数据库</span>
        <span class="token keyword">return</span> <span class="token number">666</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aenter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 异步链接数据库</span>
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aexit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 异步关闭数据库链接</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncContextManager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> f<span class="token punctuation">.</span>do_something<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-uvloop"><a href="#4-uvloop" class="headerlink" title="4. uvloop"></a>4. uvloop</h2><p><strong>uvloop 是 asyncio 的事件循环的替代方案。事件循环 &gt; 默认 asyncio 的事件循环。</strong></p>
<p><code>pip install uvloop</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> uvloop
asyncio<span class="token punctuation">.</span>set_event_loop_policy<span class="token punctuation">(</span>uvloop<span class="token punctuation">.</span>EventLoopPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 编写 asyncio 的代码，与之前写的代码一致</span>

<span class="token comment"># 内部的事件循环自动化会变为 uvloop</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<!--注意：一个 asgi ->uvicorn 内部默认使用的就是uvloop -->

<h3 id="5-实战案例"><a href="#5-实战案例" class="headerlink" title="5. 实战案例"></a>5. 实战案例</h3><h3 id="（1）异步-redis"><a href="#（1）异步-redis" class="headerlink" title="（1）异步 redis"></a>（1）异步 redis</h3><p>在使用 python 代码操作 redis 时，链接/操作/断开都是网络IO。</p>
<p><code>pip install aioredis</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#作者未设置 redis，故此代码未测试</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aioredis

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始执行'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：创建 redis 链接</span>
    redis <span class="token operator">=</span> <span class="token keyword">await</span> aioredis<span class="token punctuation">.</span>create_redis<span class="token punctuation">(</span>address<span class="token punctuation">,</span> password <span class="token operator">=</span> password<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：在 redis 中设置哈希值 car，内部再设三个键值对，即：redis = {car:{key1:1,key2:2,key3:33}}</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hmset_dict<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span> key1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> key3 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token comment"># 网络IO操作：去 redis 中获取值</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

    redis<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：关闭 redis 链接</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute<span class="token punctuation">(</span><span class="token string">'redis://47.93.4.198:6379'</span><span class="token punctuation">,</span> <span class="token string">"root!2345"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例2'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aioredis

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始执行'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：先去连接 47.93.4.197:6379 遇到IO自动切换任务，去连接 47.93.4.198:6379</span>
    redis <span class="token operator">=</span> <span class="token keyword">await</span> aioredis<span class="token punctuation">.</span>create_pool<span class="token punctuation">(</span>address<span class="token punctuation">,</span> password <span class="token operator">=</span> password<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：遇到IO自动切换任务</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hmset_dict<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span> key1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> key3 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token comment"># 网络IO操作：遇到IO自动切换任务</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

    redis<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：遇到IO自动切换任务</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
    
task_list <span class="token operator">=</span><span class="token punctuation">[</span>
    execute<span class="token punctuation">(</span><span class="token string">'redis://47.93.4.197:6379'</span><span class="token punctuation">,</span><span class="token string">'root!2345'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    execute<span class="token punctuation">(</span><span class="token string">'redis://47.93.4.198:6379'</span><span class="token punctuation">,</span><span class="token string">'root!2345'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）异步MySQL"><a href="#（2）异步MySQL" class="headerlink" title="（2）异步MySQL"></a>（2）异步MySQL</h3><p><code>pip3 install aiomysql</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例1'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiomysql

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 网络IO操作：连接 MySQL</span>
    conn <span class="token operator">=</span> <span class="token keyword">await</span> aiomysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">,</span> user <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">,</span>db<span class="token operator">=</span> <span class="token string">'mysql'</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：创建 CURSOR</span>
    cur <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment"># 网络IO操作：执行 SQL</span>
    <span class="token keyword">await</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT Host,User FROM user'</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：获取SQL结果</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：关闭 链接</span>
    <span class="token keyword">await</span> cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例2'''</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiomysql

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始'</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：先连197，遇到IO自动切换，去连198</span>
    conn <span class="token operator">=</span> <span class="token keyword">await</span> aiomysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host <span class="token operator">=</span> host<span class="token punctuation">,</span> port<span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">,</span> user <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span> password <span class="token operator">=</span> password<span class="token punctuation">,</span>db<span class="token operator">=</span> <span class="token string">'mysql'</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：遇到IO自动切换</span>
    cur <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment"># 网络IO操作：遇到IO自动切换</span>
    <span class="token keyword">await</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'SELECT Host,User FROM user'</span><span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：遇到IO自动切换</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment"># 网络IO操作：遇到IO自动切换</span>
    <span class="token keyword">await</span> cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
task_list <span class="token operator">=</span><span class="token punctuation">[</span>
    execute<span class="token punctuation">(</span><span class="token string">'47.93.4.197:6379'</span><span class="token punctuation">,</span><span class="token string">'root!2345'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    execute<span class="token punctuation">(</span><span class="token string">'47.93.4.198:6379'</span><span class="token punctuation">,</span><span class="token string">'root!2345'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）FastAPI框架"><a href="#（3）FastAPI框架" class="headerlink" title="（3）FastAPI框架"></a>（3）FastAPI框架</h3><p><code>pip3 install fastapi</code>       <code>pip3 install uvicorn</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例'''</span>
<span class="token keyword">import</span> uvicorn
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''普通操作接口'''</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"Hello World"</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"luffy:app"</span><span class="token punctuation">,</span>host<span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>port<span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''示例2'''</span>
<span class="token keyword">from</span> aioredis <span class="token keyword">import</span> Redis
<span class="token keyword">import</span> uvicorn
<span class="token keyword">import</span> aioredis
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 创建一个redis的连接池 实际运行时更换自己的redis</span>
REDIS_POOL <span class="token operator">=</span> aioredis<span class="token punctuation">.</span>ConnectionPool<span class="token punctuation">(</span><span class="token string">'redis://47.193.14.198:6379'</span><span class="token punctuation">,</span> password<span class="token operator">=</span> <span class="token string">'root123'</span><span class="token punctuation">,</span> minsize <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">,</span> maxsize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''普通操作接口'''</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"Hello World"</span><span class="token punctuation">}</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">'/red'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">red</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 异步操作接口</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求来了'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 连接池获取一个连接</span>
    conn <span class="token operator">=</span> <span class="token keyword">await</span> REDIS_POOL<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    redis <span class="token operator">=</span> Redis<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    
    <span class="token comment"># 设置值</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hmset_dict<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span>key1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>key2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>key3 <span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 读取值</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span><span class="token string">'car'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    
    <span class="token comment">#连接归还连接池</span>
    REDIS_POOL<span class="token punctuation">.</span>release<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"脚本名:app"</span><span class="token punctuation">,</span>host<span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>port<span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（4）异步爬虫"><a href="#（4）异步爬虫" class="headerlink" title="（4）异步爬虫"></a>（4）异步爬虫</h3><p><code>pip3 install aiohttp</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''使用aiohttp模块下载    协程方式'''</span>
<span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'发送请求：'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> verify_ssl <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
        text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
        file_name <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'得到结果：'</span><span class="token punctuation">,</span> url <span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> text

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        url_list <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string">'https://python.org'</span><span class="token punctuation">,</span>
            <span class="token string">'https://www.baidu.com'</span><span class="token punctuation">,</span>
            <span class="token string">'https://www.pythonav.com'</span>
        <span class="token punctuation">]</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> url_list<span class="token punctuation">]</span>
        done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">在月光下滑坡</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://a1561532803.github.io/yueguang.github.io/posts/13804.html">https://a1561532803.github.io/yueguang.github.io/posts/13804.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">在月光下滑坡</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E7%88%AC%E8%99%AB/">
                                    <span class="chip bg-color">爬虫</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'GPRF1lmszFyc6eX6xgp5sP7T-gzGzoHsz',
        appKey: 'jcru0ckFznlB1ALgLQc1XxmJ',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '说点什么吧？'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/posts/13804.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="爬虫——基础篇">
                        
                        <span class="card-title">爬虫——基础篇</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/python/" class="post-category">
                                    python
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%88%AC%E8%99%AB/">
                        <span class="chip bg-color">爬虫</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/35894.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="CSS——Multi-column Layout 布局">
                        
                        <span class="card-title">CSS——Multi-column Layout 布局</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web%E5%BC%80%E5%8F%91/" class="post-category">
                                    web开发
                                </a>
                            
                            <a href="/categories/web%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/" class="post-category">
                                    前端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CSS/">
                        <span class="chip bg-color">CSS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 在月光下滑坡<br />'
            + '文章作者: 在月光下滑坡<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">在月光下滑坡</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "7";
                    var startDate = "4";
                    var startHour = "18";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/a1561532803" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:fade156@email.cn" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1561532803" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1561532803" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="https://blog.csdn.net/a1561532803?spm=1000.2115.3001.5343" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/a1561532803?spm=1000.2115.3001.5343" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!--动态线条背景-->
    <script type="text/javascript"
    color="82, 69, 202" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
